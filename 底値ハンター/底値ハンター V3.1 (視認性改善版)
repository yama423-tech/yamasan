//@version=5
indicator("底値ハンター V3.2 (精度改善版)", overlay=true, shorttitle="底値ハンターV3.2")

// ==========================================
// 1. 設定
// ==========================================
// 感度設定
grpSignal = "シグナル感度"
lookback      = input.int(5, "ダイバージェンス判定期間(本)", minval=1, group=grpSignal)
rsiLen        = input.int(14, "RSI期間", group=grpSignal)
rsiOversold   = input.int(30, "RSI売られすぎライン", group=grpSignal)
minRsiLift    = input.float(2.0, "ダイバージェンス時のRSI改善幅(最小)", minval=0.0, step=0.5, group=grpSignal)
cooldownBars  = input.int(3, "シグナル間隔(バー)", minval=0, group=grpSignal)
requireBull   = input.bool(true, "陽線確定を必須にする", group=grpSignal)

// ボリンジャーバンド
grpBB = "ボラティリティ"
bbLen         = input.int(20, "ボリンジャーバンド期間", group=grpBB)
bbMult        = input.float(2.0, "バンド偏差(σ)", group=grpBB)
useVolatilityFilter = input.bool(true, "低ボラ相場フィルターを使う", group=grpBB)
minBbWidthPct = input.float(1.2, "最低BB幅(%)", minval=0.1, step=0.1, group=grpBB)

// フィルター
grpFilter = "環境フィルター"
useVol        = input.bool(true, "出来高(セリングクライマックス)判定を使う", group=grpFilter)
volMult       = input.float(2.0, "平均出来高の何倍でパニックとみなすか", minval=0.1, step=0.1, group=grpFilter)
trendMode     = input.string("無効", "トレンド条件", options=["無効", "逆張り(EMA200下)", "順張り(EMA200上)"], group=grpFilter)

// ==========================================
// 2. 計算ロジック
// ==========================================
// 基本データ
rsi     = ta.rsi(close, rsiLen)
[mid, upper, lower] = ta.bb(close, bbLen, bbMult)
ema200  = ta.ema(close, 200)
ema5    = ta.ema(close, 5)

// 出来高判定
volMa   = ta.sma(volume, 20)
isPanicVol = useVol ? (volume > volMa * volMult) : true

// トレンドフィルター
trendOk = trendMode == "逆張り(EMA200下)" ? close < ema200 : trendMode == "順張り(EMA200上)" ? close > ema200 : true

// ボラティリティフィルター
bbWidthPct = mid != 0.0 ? (upper - lower) / mid * 100.0 : 0.0
volatilityOk = useVolatilityFilter ? bbWidthPct >= minBbWidthPct : true

// ローソク足確認
bullOk = requireBull ? close > open : true

// ==========================================
// 3. 特殊な底打ちパターン検知
// ==========================================

// A. RSIダイバージェンス
wasOversold = ta.lowest(rsi, 10) < rsiOversold
isDivRaw = (low < low[lookback]) and (rsi > rsi[lookback]) and wasOversold
isDiv = isDivRaw and (rsi - rsi[lookback] >= minRsiLift)

// B. セリングクライマックス
float body = math.abs(close - open)
float wick = math.min(close, open) - low
bool isPinbar = wick > body * 1.5
bool isCrash  = (low < lower) and isPanicVol and isPinbar

// ==========================================
// 4. エントリートリガー
// ==========================================
cross5EMA = ta.crossover(close, ema5)

// パターン1: ダイバージェンス
buyDiv = isDiv and cross5EMA and trendOk and volatilityOk and bullOk

// パターン2: クラッシュ(セリングクライマックス)
buyCrash = isCrash and trendOk and volatilityOk and bullOk

// パターン3: 安全圏回復 (V2ロジック)
buyRecovery = wasOversold and cross5EMA and rsi > rsiOversold and trendOk and volatilityOk and bullOk

// 統合シグナル
var int lastBuy = 0
rawSignal = buyDiv or buyCrash or buyRecovery
signal = rawSignal and (bar_index - lastBuy > cooldownBars)

if signal
    lastBuy := bar_index

// シグナル強度 (目安)
signalScore = (buyDiv ? 2 : 0) + (buyCrash ? 2 : 0) + (buyRecovery ? 1 : 0) + (isPanicVol ? 1 : 0) + (wasOversold ? 1 : 0)
strongSignal = signal and signalScore >= 4

// ==========================================
// 5. 描画
// ==========================================

// バンド描画
p1 = plot(upper, "Upper", color=color.new(color.red, 90))
p2 = plot(lower, "Lower", color=color.new(color.blue, 90))
fill(p1, p2, color=color.new(color.gray, 95))
plot(mid, "20 SMA", color=color.orange, linewidth=1)
plot(ema5, "5 EMA", color=color.aqua, linewidth=2)
plot(ema200, "200 EMA", color=color.new(color.yellow, 40), linewidth=1)

// シグナル描画
plotshape(signal and buyCrash, title="Panic Buy", location=location.belowbar, color=color.purple, style=shape.labelup, size=size.normal, text="BOTTOM", textcolor=color.white)
plotshape(signal and buyDiv and not buyCrash, title="Div Buy", location=location.belowbar, color=color.orange, style=shape.labelup, size=size.normal, text="Div\nBUY", textcolor=color.white)
plotshape(signal and buyRecovery and not buyDiv and not buyCrash, title="Recovery Buy", location=location.belowbar, color=color.white, style=shape.circle, size=size.small, text="", textcolor=color.black)
plotshape(strongSignal, title="Strong Signal", location=location.belowbar, color=color.lime, style=shape.triangleup, size=size.tiny, text="A+", textcolor=color.black)

// アラート
alertcondition(signal, "底値ハンター・エントリー", "底打ちからの反転シグナル点灯！")
alertcondition(strongSignal, "底値ハンター・強シグナル", "複数条件一致の強い反転シグナルです。")
