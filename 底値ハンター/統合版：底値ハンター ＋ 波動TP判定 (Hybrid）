//@version=6
indicator("çµ±åˆç‰ˆï¼šåº•å€¤ãƒãƒ³ã‚¿ãƒ¼ ï¼‹ æ³¢å‹•TPåˆ¤å®š (Hybrid)", overlay=true, shorttitle="Hunter-Wave Hybrid", scale=scale.right)

// ==========================================
// ğŸ›  1. è¨­å®šï¼šåº•å€¤ãƒãƒ³ã‚¿ãƒ¼ (Hunter Logic)
// ==========================================
grp_hunter = "ã€è¨­å®šã€‘åº•å€¤ãƒãƒ³ã‚¿ãƒ¼ (Bottom Logic)"
target_group = input.string("Current Chart", "ç›£è¦–å¯¾è±¡ (ãƒ‘ãƒãƒ«ç”¨)", 
     options=[
         "Current Chart", 
         "--- 7å¤§å•†ç¤¾ ---", "Itochu (8001)", "Mitsubishi (8058)", "Mitsui (8031)", "Sumitomo (8053)", 
         "Marubeni (8002)", "Toyota Tsusho (8015)", "Sojitz (2768)",
         "--- ãƒ¡ã‚¬ãƒãƒ³ã‚¯ ---", "MUFG (8306)", "SMFG (8316)", "Mizuho (8411)",
         "--- æŒ‡æ•°ãƒ»ETF ---", "Nikkei 225 (ETF 1321)", "TOPIX (ETF 1306)", "S&P 500 (ETF SPY)"
     ], group=grp_hunter)

sensitivity = input.string("Lv3 (Normal)", "æ„Ÿåº¦è¨­å®š (è²·ã„åˆ¤å®š)", 
     options=["Lv1 (Very Hard)", "Lv2 (Hard)", "Lv3 (Normal)", "Lv4 (Easy)", "Lv5 (Very Easy)"], 
     tooltip="Lv1: RSI<20 (æ·±ã„åº•), Lv5: RSI<40 (æµ…ã„æŠ¼ã—ç›®)", group=grp_hunter)

show_hunter_tbl = input.bool(true, "åº•å€¤ç›£è¦–ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º (å³ä¸Š)", group=grp_hunter)

// ==========================================
// ğŸ›  2. è¨­å®šï¼šãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»TP/SL (WTP Logic)
// ==========================================
grp_logic = "ã€è¨­å®šã€‘ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»TPç®—å‡º (WTP Logic)"
tfMode    = input.string("è‡ªå‹•", "æ™‚é–“è¶³ãƒ¢ãƒ¼ãƒ‰", options=["è‡ªå‹•","æ‰‹å‹•"], group=grp_logic)
tfManual  = input.string("ã‚¹ã‚¤ãƒ³ã‚°", "ï¼ˆæ‰‹å‹•æ™‚ï¼‰è¨­å®š", options=["çŸ­æœŸ","ã‚¹ã‚¤ãƒ³ã‚°","ä¸­æœŸ","é•·æœŸ"], group=grp_logic)
filterStr = input.string("æ¨™æº–", "åˆ¤å®šã‚·ãƒ“ã‚¢åº¦", options=["ç·©ã‚", "æ¨™æº–", "å³ã—ã‚"], group=grp_logic)

grp_risk  = "ã€è¨­å®šã€‘ãƒªã‚¹ã‚¯ç®¡ç† (TP/SL)"
slMult_in = input.float(1.5, "SL (ATRå€ç‡)", step=0.1, group=grp_risk)
tp1Mult_in= input.float(2.0, "TP1 (ATRå€ç‡)", step=0.1, group=grp_risk)
tp2Mult_in= input.float(4.0, "TP2 (ATRå€ç‡)", step=0.1, group=grp_risk, tooltip="è°·åº•ã‹ã‚‰ã®å¤§ããªãƒªãƒ¯ãƒ¼ãƒ‰ã‚’ç‹™ã†ãŸã‚åºƒã‚ã«è¨­å®šæ¨å¥¨")
showLines = input.bool(true, "TP/SLãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º", group=grp_risk)

grp_vis   = "ã€è¡¨ç¤ºã€‘ãƒ‡ã‚¶ã‚¤ãƒ³"
showMA    = input.bool(true, "MAãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º", group=grp_vis)
showWtpTbl= input.bool(true, "ãƒˆãƒ¬ãƒ¼ãƒ‰çŠ¶æ³ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º (å³ä¸‹)", group=grp_vis)

// ==========================================
// ğŸ§  3. ãƒ­ã‚¸ãƒƒã‚¯å…±é€šè¨ˆç®—
// ==========================================
// ATR (å…±é€š)
atr = ta.atr(14)

// --- Hunterç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---
var float rsi_limit = 30.0
var float bb_dev    = 2.0
if sensitivity == "Lv1 (Very Hard)"
    rsi_limit := 20.0, bb_dev := 2.4
else if sensitivity == "Lv2 (Hard)"
    rsi_limit := 25.0, bb_dev := 2.2
else if sensitivity == "Lv3 (Normal)"
    rsi_limit := 30.0, bb_dev := 2.0
else if sensitivity == "Lv4 (Easy)"
    rsi_limit := 35.0, bb_dev := 1.8
else
    rsi_limit := 40.0, bb_dev := 1.6

// --- WTPç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•åˆ‡æ›¿) ---
var int maFast = 20, maMid = 60, maLong = 200
var float volMultBase = 1.2
var int volLen = 60

var string autoMode = timeframe.isminutes ? "çŸ­æœŸ" : "ã‚¹ã‚¤ãƒ³ã‚°"
string selMode = tfMode == "è‡ªå‹•" ? autoMode : tfManual

if selMode == "çŸ­æœŸ"
    maFast := 10, maMid := 40, maLong := 150
else if selMode == "ã‚¹ã‚¤ãƒ³ã‚°"
    maFast := 20, maMid := 60, maLong := 200
else 
    maFast := 30, maMid := 90, maLong := 220

// MAè¨ˆç®—
emaF = ta.ema(close, maFast)
emaM = ta.ema(close, maMid)
emaL = ta.ema(close, maLong)
plot(showMA ? emaL : na, "MAé•·æœŸ", color=color.new(color.gray, 50), linewidth=2)
plot(showMA ? emaM : na, "MAä¸­æœŸ", color=color.new(color.orange, 50), linewidth=1)

// ==========================================
// ğŸ“‰ 4. Hunterãƒ­ã‚¸ãƒƒã‚¯ (åº•å€¤åˆ¤å®š)
// ==========================================
// ç¾åœ¨ã®ãƒãƒ£ãƒ¼ãƒˆã§ã®åº•å€¤åˆ¤å®š
[h_rsi, h_basis, h_dev] = request.security(syminfo.tickerid, timeframe.period, [ta.rsi(close, 14), ta.sma(close, 20), ta.stdev(close, 20)])
float h_lower_bb = h_basis - (bb_dev * h_dev)
bool is_hunter_buy = close < h_lower_bb and h_rsi < rsi_limit

// è°·åº•ã‚µã‚¤ãƒ³è¡¨ç¤º
plotshape(is_hunter_buy, "åº•å€¤æ‹¾ã„", shape.triangleup, location.belowbar, color.red, size=size.small, text="Bottom", textcolor=color.red)
bgcolor(is_hunter_buy ? color.new(color.red, 90) : na, title="Hunter Zone")

// ==========================================
// ğŸ“ˆ 5. WTPãƒ­ã‚¸ãƒƒã‚¯ (ãƒˆãƒ¬ãƒ³ãƒ‰æ³¢å‹•åˆ¤å®š)
// ==========================================
// ãƒˆãƒ¬ãƒ³ãƒ‰å®šç¾©
trendUp = emaF > emaM and emaM > emaL
volAvg = ta.sma(volume, volLen)
volOK = volume > volAvg * volMultBase // ç°¡æ˜“åˆ¤å®š

// æ³¢å‹•èªè­˜
ph = ta.pivothigh(high, 3, 3)
lastSwingHigh = ta.valuewhen(not na(ph), ph, 0)

// Wave 1 (åˆå‹•)
wave1 = trendUp and close > lastSwingHigh and close[1] <= lastSwingHigh
// Wave 2 (æŠ¼ã—ç›®)
wave2 = trendUp and close < emaF and close > emaM and ta.crossover(close, emaF)
// Wave 3 (åŠ é€Ÿ)
reAccel = ta.crossover(close, lastSwingHigh)
wave3 = trendUp and reAccel

// ã‚µã‚¤ãƒ³è¡¨ç¤º
plotshape(wave1, "ç¬¬1æ³¢", shape.labelup, location.belowbar, color.new(color.green, 20), size=size.tiny, text="W1", textcolor=color.white)
plotshape(wave2, "ç¬¬2æ³¢", shape.labelup, location.belowbar, color.new(color.teal, 20), size=size.tiny, text="W2", textcolor=color.white)
plotshape(wave3, "ç¬¬3æ³¢", shape.labelup, location.belowbar, color.new(color.lime, 10), size=size.tiny, text="W3", textcolor=color.black)

// ==========================================
// ğŸ’¹ 6. çµ±åˆãƒˆãƒ¬ãƒ¼ãƒ‰ç®¡ç† (Entry & TP/SL)
// ==========================================
var bool  inTrade = false
var float enPrice = na
var float tp1Price = na
var float tp2Price = na
var float slPrice = na
var string entryType = ""

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆ¤å®š (Hunter ã¾ãŸã¯ WTPæ³¢å‹•)
bool entry_signal = is_hunter_buy or wave1 or wave2 or wave3

// ä¿®æ­£ç®‡æ‰€ï¼šnotã¨inTradeã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ 
if entry_signal and not inTrade
    inTrade := true
    enPrice := close
    
    // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç¨®é¡è¨˜éŒ²
    if is_hunter_buy
        entryType := "Bottom"
    else if wave1
        entryType := "Wave1"
    else if wave2
        entryType := "Wave2"
    else 
        entryType := "Wave3"

    // TP/SLè¨ˆç®—
    tp1Price := enPrice + atr * tp1Mult_in
    tp2Price := enPrice + atr * tp2Mult_in
    slPrice  := enPrice - atr * slMult_in

// æ±ºæ¸ˆåˆ¤å®š
hitTP1 = inTrade and high >= tp1Price
hitTP2 = inTrade and high >= tp2Price
hitSL  = inTrade and low <= slPrice

// æ±ºæ¸ˆãƒãƒ¼ã‚«ãƒ¼
plotchar(hitTP1, title="TP1", char="1", location=location.abovebar, color=color.green, text="TP1", textcolor=color.green, size=size.tiny)
plotchar(hitTP2, title="TP2", char="â˜…", location=location.abovebar, color=color.green, text="TP2 Done", textcolor=color.green, size=size.small)
plotchar(hitSL,  title="SL",  char="x", location=location.abovebar, color=color.red,   text="SL", textcolor=color.red,   size=size.tiny)

// ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ (TP2ã¾ãŸã¯SLã§çµ‚äº†)
if hitTP2 or hitSL
    inTrade := false
    enPrice := na
    entryType := ""

// ãƒ©ã‚¤ãƒ³æç”»
var line l_tp1 = na, var line l_tp2 = na, var line l_sl = na, var line l_en = na
