//@version=5
indicator("WTP20 Replica Strategy [銘柄分析]", overlay=true)

// --- 設定値 (Inputs) ---
len_bb = input.int(20, "Bollinger Band Length")
mult_bb = input.float(2.0, "BB Multiplier")
len_rsi = input.int(14, "RSI Length")
len_adx = input.int(14, "ADX Length")
adx_threshold = input.int(25, "ADX Threshold (勢い)")

// --- 計算 (Calculations) ---
// ボリンジャーバンド
[middle, upper, lower] = ta.bb(close, len_bb, mult_bb)
plot(upper, color=color.new(color.red, 50), title="BB Upper")
plot(middle, color=color.new(color.orange, 0), title="BB SMA")
plot(lower, color=color.new(color.blue, 50), title="BB Lower")

// 移動平均線（リボン風）
ma1 = ta.sma(close, 20)
ma2 = ta.sma(close, 50)
ma3 = ta.sma(close, 100)
// 短期が長期より上なら上昇トレンド
is_uptrend = ma1 > ma2 and ma2 > ma3

// RSI & ADX
rsi_val = ta.rsi(close, len_rsi)
[diplus, diminus, adx_val] = ta.dmi(len_adx, len_adx)

// --- ロジック判定 (Signal Logic) ---
// 買い条件: 上昇トレンド中 + RSIが売られすぎではない + ADXで勢いがある + 陽線
buy_condition = is_uptrend and rsi_val > 50 and rsi_val < 70 and adx_val > adx_threshold and close > open

// 状態判定
var string signal_status = "待機中"
var color status_color = color.gray

if buy_condition
    signal_status := "買いシグナル"
    status_color := color.green
else if rsi_val > 75
    signal_status := "加熱警戒"
    status_color := color.red
else
    signal_status := "待機中"
    status_color := color.gray

// --- シグナル描画 (Plotting) ---
plotshape(buy_condition, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small, text="BUY")

// --- ダッシュボード表示 (Dashboard Table) ---
var table panel = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 30), border_color=color.gray, border_width=1)

if barstate.islast
    // ヘッダー
    table.cell(panel, 0, 0, "WTP20 Monitor", text_color=color.white, text_size=size.small, bgcolor=color.navy)
    table.cell(panel, 1, 0, syminfo.ticker, text_color=color.white, text_size=size.small, bgcolor=color.navy)
    
    // トレンド
    table.cell(panel, 0, 1, "トレンド", text_color=color.white)
    table.cell(panel, 1, 1, is_uptrend ? "上昇 ↗" : "下降 ↘", text_color=is_uptrend ? color.green : color.red)
    
    // ADX
    table.cell(panel, 0, 2, "ADX(勢い)", text_color=color.white)
    table.cell(panel, 1, 2, str.tostring(adx_val, "#.##"), text_color=adx_val > adx_threshold ? color.orange : color.gray)
    
    // RSI
    table.cell(panel, 0, 3, "RSI(14)", text_color=color.white)
    table.cell(panel, 1, 3, str.tostring(rsi_val, "#.##"), text_color=rsi_val > 70 ? color.red : color.white)
    
    // 現在値
    table.cell(panel, 0, 4, "現在値", text_color=color.white)
    table.cell(panel, 1, 4, str.tostring(close), text_color=color.white)
    
    // シグナル状態
    table.cell(panel, 0, 5, "Active Signal", text_color=color.white)
    table.cell(panel, 1, 5, signal_status, text_color=status_color, bgcolor=color.new(status_color, 80))
