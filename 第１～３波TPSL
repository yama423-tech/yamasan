//@version=6
indicator("æœ‰æœ›20éŠ˜æŸ„ç”¨ï¼šç¬¬1/ç¬¬2/ç¬¬3æ³¢ï¼‹TP/SLå¸¯ï¼ˆPro UIç‰ˆï¼‰", overlay=true, shorttitle="WTP20 Pro", scale=scale.right)

// ==========================================
// ğŸ›  è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
// ==========================================

// --- 1. ç²¾åº¦ãƒ»ãƒ­ã‚¸ãƒƒã‚¯èª¿æ•´ ---
grp_logic = "ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ç²¾åº¦èª¿æ•´"
tfMode    = input.string("è‡ªå‹•", "æ™‚é–“è¶³ãƒ¢ãƒ¼ãƒ‰", options=["è‡ªå‹•","æ‰‹å‹•"], group=grp_logic)
tfManual  = input.string("ã‚¹ã‚¤ãƒ³ã‚°", "ï¼ˆæ‰‹å‹•æ™‚ï¼‰è¨­å®š", options=["çŸ­æœŸ","ã‚¹ã‚¤ãƒ³ã‚°","ä¸­æœŸ","é•·æœŸ"], group=grp_logic)
filterStr = input.string("æ¨™æº–", "åˆ¤å®šã‚·ãƒ“ã‚¢åº¦ï¼ˆãƒ€ãƒã‚·å›é¿ï¼‰", options=["ç·©ã‚", "æ¨™æº–", "å³ã—ã‚"], group=grp_logic, tooltip="å³ã—ã‚ï¼å¼·ã„ãƒˆãƒ¬ãƒ³ãƒ‰ã¨å‡ºæ¥é«˜ãŒå¿…è¦ï¼ˆæ©Ÿä¼šã¯æ¸›ã‚‹ãŒå‹ç‡é‡è¦–ï¼‰")

// --- 2. ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»UI ---
grp_vis   = "è¡¨ç¤ºãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³"
showMA    = input.bool(true, "MAãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º", group=grp_vis)
showTable = input.bool(true, "æƒ…å ±ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆå³ä¸Šï¼‰", group=grp_vis)
bgColor   = input.color(color.new(color.black, 50), "ãƒ‘ãƒãƒ«èƒŒæ™¯è‰²", group=grp_vis)
txtColor  = input.color(color.white, "ãƒ‘ãƒãƒ«æ–‡å­—è‰²", group=grp_vis)
lblSize   = input.string("small", "ãƒ‘ãƒãƒ«æ–‡å­—ã‚µã‚¤ã‚º", options=["tiny", "small", "normal", "large"], group=grp_vis)

// --- 3. ãƒªã‚¹ã‚¯ç®¡ç† ---
grp_risk  = "ãƒªã‚¹ã‚¯ç®¡ç†ï¼ˆTP/SLï¼‰"
useAlert  = input.bool(true, "ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰åŠ¹åŒ–", group=grp_risk)
showLines = input.bool(true, "ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸­ã®TP/SLãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º", group=grp_risk)

// ==========================================
// ğŸ§  ãƒ­ã‚¸ãƒƒã‚¯è¨ˆç®—éƒ¨
// ==========================================

// --- æ™‚é–“è¶³åˆ¤å®š ---
var string tfClass = "æ—¥è¶³"
if timeframe.isminutes
    tfClass := timeframe.multiplier <= 15 ? "è¶…çŸ­æœŸ" : "çŸ­æœŸ"
else if timeframe.isdaily
    tfClass := "æ—¥è¶³"
else if timeframe.isweekly
    tfClass := "é€±è¶³"
else
    tfClass := "ãã®ä»–"

// --- ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š ---
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
var int maFast = 20, maMid = 60, maLong = 200
var int atrLen = 14, adxLen = 14
var float slMult = 1.2, tp1Mult = 1.2, tp2Mult = 2.0
var float volMultBase = 1.2
var int volLen = 60

// è‡ªå‹•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
var string autoMode = "ã‚¹ã‚¤ãƒ³ã‚°"
autoMode := timeframe.isminutes ? (timeframe.multiplier <= 60 ? "çŸ­æœŸ" : "ã‚¹ã‚¤ãƒ³ã‚°") : timeframe.isdaily ? "ã‚¹ã‚¤ãƒ³ã‚°" : "ä¸­æœŸ"
string selMode = tfMode == "è‡ªå‹•" ? autoMode : tfManual

// ãƒ¢ãƒ¼ãƒ‰é©ç”¨
if selMode == "çŸ­æœŸ"
    maFast := 10, maMid := 40, maLong := 150
    atrLen := 12, adxLen := 12
    slMult := 1.0, tp1Mult := 1.0, tp2Mult := 1.6
    volMultBase := 1.1
    volLen := 40
else if selMode == "ã‚¹ã‚¤ãƒ³ã‚°"
    maFast := 20, maMid := 60, maLong := 200
    atrLen := 14, adxLen := 14
    slMult := 1.2, tp1Mult := 1.2, tp2Mult := 2.0
    volMultBase := 1.2
    volLen := 60
else // ä¸­æœŸãƒ»é•·æœŸ
    maFast := 30, maMid := 90, maLong := 220
    atrLen := 18, adxLen := 18
    slMult := 1.3, tp1Mult := 1.3, tp2Mult := 2.2
    volMultBase := 1.25
    volLen := 80

// --- åˆ¤å®šã‚·ãƒ“ã‚¢åº¦ï¼ˆBuyç²¾åº¦ï¼‰ã®é©ç”¨ ---
// å³ã—ã‚ï¼šADXè¦æ±‚â†‘ã€å‡ºæ¥é«˜è¦æ±‚â†‘
// ç·©ã‚ï¼šADXè¦æ±‚â†“ã€å‡ºæ¥é«˜è¦æ±‚â†“
float adxTh = 20.0
float volMult = volMultBase

if filterStr == "å³ã—ã‚"
    adxTh := 25.0
    volMult := volMultBase * 1.3
else if filterStr == "ç·©ã‚"
    adxTh := 15.0
    volMult := volMultBase * 0.8

// --- ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¨ˆç®— ---
// ADXé–¢æ•°
f_adx(_len) =>
    up = ta.change(high)
    dn = -ta.change(low)
    plusDM = (up > dn and up > 0) ? up : 0
    minusDM = (dn > up and dn > 0) ? dn : 0
    tr = ta.tr(true)
    trRma = ta.rma(tr, _len)
    pDI = trRma == 0 ? 0 : 100 * ta.rma(plusDM, _len) / trRma
    mDI = trRma == 0 ? 0 : 100 * ta.rma(minusDM, _len) / trRma
    dx = (pDI + mDI == 0) ? 0 : 100 * math.abs(pDI - mDI) / (pDI + mDI)
    ta.rma(dx, _len)

emaF = ta.ema(close, maFast)
emaM = ta.ema(close, maMid)
emaL = ta.ema(close, maLong)
atr  = ta.atr(atrLen)
adx  = f_adx(adxLen)
volAvg = ta.sma(volume, volLen)

// ãƒˆãƒ¬ãƒ³ãƒ‰å®šç¾©
trendUp = emaF > emaM and emaM > emaL
volOK   = volume > volAvg * volMult

// MAæç”»
plot(showMA ? emaL : na, "MAé•·æœŸ", color=color.new(color.gray, 50), linewidth=2)
plot(showMA ? emaM : na, "MAä¸­æœŸ", color=color.new(color.orange, 50), linewidth=1)

// --- æ³¢å½¢èªè­˜ãƒ­ã‚¸ãƒƒã‚¯ ---
ph = ta.pivothigh(high, 3, 3)
lastSwingHigh = ta.valuewhen(not na(ph), ph, 0)

// ç¬¬1æ³¢ï¼ˆåˆå‹•ï¼‰
wave1_cond = trendUp and volOK and adx > adxTh and not na(lastSwingHigh) and close > lastSwingHigh and close[1] <= lastSwingHigh
var bool wave1Context = false
var int wave1Bar = 0
if wave1_cond
    wave1Context := true
    wave1Bar := bar_index
else if bar_index - wave1Bar > 200 // æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ
    wave1Context := false

// ç¬¬2æ³¢ï¼ˆæŠ¼ã—ç›®ï¼‰
pullbackOK = close > emaM and close < emaF // èª¿æ•´ä¸­
reboundOK  = ta.crossover(close, emaF) // å†æµ®ä¸Š
wave2_cond = wave1Context and trendUp and adx > adxTh * 0.9 and reboundOK

var bool wave2Context = false
var int wave2Bar = 0
if wave2_cond
    wave2Context := true
    wave2Bar := bar_index
else if bar_index - wave2Bar > 200
    wave2Context := false

// ç¬¬3æ³¢ï¼ˆå†åŠ é€Ÿãƒ»ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ãªã—ï¼‰
// ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ç°¡æ˜“åˆ¤å®š
rsi = ta.rsi(close, 14)
rsiPH = ta.pivothigh(rsi, 5, 5)
bearDiv = false 
if not na(rsiPH) and not na(ph)
    if ph > ph[1] and rsiPH < rsiPH[1] // ä¾¡æ ¼åˆ‡ã‚Šä¸Šã’ãƒ»RSIåˆ‡ã‚Šä¸‹ã’
        bearDiv := true

reAccel = ta.crossover(close, lastSwingHigh)
wave3_cond = (wave2Context or wave1Context) and trendUp and reAccel and not bearDiv and volOK

// æš´è½ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆç°¡ç•¥åŒ–ï¼‰
crashFilter = (ta.highest(high, 60) - close) / ta.highest(high, 60) < 0.15 // ç›´è¿‘é«˜å€¤ã‹ã‚‰15%ä»¥ä¸Šè½ã¡ã¦ã„ãªã„ã“ã¨

// æœ€çµ‚ã‚·ã‚°ãƒŠãƒ«
wave1 = wave1_cond and crashFilter
wave2 = wave2_cond and crashFilter
wave3 = wave3_cond and crashFilter

// ==========================================
// ğŸ’¹ ãƒˆãƒ¬ãƒ¼ãƒ‰ç®¡ç† & è¡¨ç¤º
// ==========================================
var bool  inTrade = false
var float enPrice = na
var float tp1Price = na
var float tp2Price = na
var float slPrice = na
var string sigType = ""

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼å‡¦ç†
if (wave1 or wave2 or wave3) and barstate.isconfirmed
    inTrade := true
    enPrice := close
    sigType := wave1 ? "ç¬¬1æ³¢" : wave2 ? "ç¬¬2æ³¢" : "ç¬¬3æ³¢"
    
    // ç¬¬3æ³¢ã¯ä¼¸ã³ã—ã‚ãŒå¤§ãã„ã®ã§TPã‚’æ·±ãã€SLã‚’æµ…ã
    _tp1M = wave3 ? 1.6 : tp1Mult
    _tp2M = wave3 ? 2.6 : tp2Mult
    _slM  = wave3 ? 1.1 : slMult
    
    tp1Price := enPrice + atr * _tp1M
    tp2Price := enPrice + atr * _tp2M
    slPrice  := enPrice - atr * _slM

// æ±ºæ¸ˆåˆ¤å®š
hitTP1 = inTrade and high >= tp1Price
hitTP2 = inTrade and high >= tp2Price
hitSL  = inTrade and low <= slPrice

// ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼‰
plotshape(wave1, "ç¬¬1æ³¢", shape.labelup, location.belowbar, color.new(color.green, 20), size=size.small, text="Wave1", textcolor=color.white)
plotshape(wave2, "ç¬¬2æ³¢", shape.labelup, location.belowbar, color.new(color.teal, 20), size=size.small, text="Wave2", textcolor=color.white)
plotshape(wave3, "ç¬¬3æ³¢", shape.labelup, location.belowbar, color.new(color.lime, 10), size=size.small, text="Wave3", textcolor=color.black)

// ä¿®æ­£ç®‡æ‰€ï¼šploticon â†’ plotchar
// æ±ºæ¸ˆè¡¨ç¤ºï¼ˆTP/SLï¼‰
plotchar(hitTP1, title="TP1", char="âœ…", location=location.abovebar, color=color.green, text="TP1", textcolor=color.green, size=size.tiny)
plotchar(hitSL,  title="SL",  char="âŒ", location=location.abovebar, color=color.red,   text="SL", textcolor=color.red,   size=size.tiny)

if hitTP2 or hitSL
    inTrade := false
    enPrice := na

// ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼ˆshowLinesãŒONã®ã¨ãã®ã¿ï¼‰
var line l_tp1 = na, var line l_tp2 = na, var line l_sl = na
if showLines and inTrade
    line.delete(l_tp1), line.delete(l_tp2), line.delete(l_sl)
    l_tp1 := line.new(bar_index, tp1Price, bar_index+5, tp1Price, color=color.green, style=line.style_dashed)
    l_tp2 := line.new(bar_index, tp2Price, bar_index+5, tp2Price, color=color.green, style=line.style_dashed)
    l_sl  := line.new(bar_index, slPrice,  bar_index+5, slPrice,  color=color.red,   style=line.style_solid, width=2)

// ==========================================
// ğŸ–¥ æƒ…å ±ãƒ‘ãƒãƒ« (Table)
// ==========================================
var table statusTbl = table.new(position.top_right, 2, 6, bgcolor=bgColor, border_color=color.new(color.gray, 80), border_width=1, frame_color=color.new(color.gray, 80), frame_width=1)

if showTable and barstate.islast
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    table.merge_cells(statusTbl, 0, 0, 1, 0)
    table.cell(statusTbl, 0, 0, "WTP20 Monitor (" + selMode + ")", text_color=txtColor, text_size=lblSize, bgcolor=color.new(bgColor, 20))
    
    // ãƒ‡ãƒ¼ã‚¿è¡Œ
    c_trend = trendUp ? color.green : color.red
    txt_trend = trendUp ? "ä¸Šæ˜‡" : "ä¸‹é™/ãƒ¬ãƒ³ã‚¸"
    
    table.cell(statusTbl, 0, 1, "ãƒˆãƒ¬ãƒ³ãƒ‰", text_color=txtColor, text_size=lblSize)
    table.cell(statusTbl, 1, 1, txt_trend, text_color=c_trend, text_size=lblSize)
    
    table.cell(statusTbl, 0, 2, "ADX(å‹¢ã„)", text_color=txtColor, text_size=lblSize)
    table.cell(statusTbl, 1, 2, str.tostring(adx, "#.##"), text_color=adx>adxTh ? color.yellow : txtColor, text_size=lblSize)
    
    table.cell(statusTbl, 0, 3, "åˆ¤å®šã‚·ãƒ“ã‚¢åº¦", text_color=txtColor, text_size=lblSize)
    table.cell(statusTbl, 1, 3, filterStr, text_color=txtColor, text_size=lblSize)
    
    // ç¾åœ¨ã®ãƒã‚¸ã‚·ãƒ§ãƒ³æƒ…å ±
    table.cell(statusTbl, 0, 4, "Active Signal", text_color=txtColor, text_size=lblSize)
    table.cell(statusTbl, 1, 4, inTrade ? sigType : "å¾…æ©Ÿä¸­", text_color=inTrade ? color.lime : color.gray, text_size=lblSize)
    
    if inTrade
        table.merge_cells(statusTbl, 0, 5, 1, 5)
        infoTxt = "EP:" + str.tostring(enPrice, format.mintick) + "\nTP1:" + str.tostring(tp1Price, format.mintick) + " / SL:" + str.tostring(slPrice, format.mintick)
        table.cell(statusTbl, 0, 5, infoTxt, text_color=txtColor, text_size=lblSize)

// ==========================================
// ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆ
// ==========================================
alertcondition(wave1, "ç¬¬1æ³¢IN", "ç¬¬1æ³¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼")
alertcondition(wave2, "ç¬¬2æ³¢IN", "ç¬¬2æ³¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼")
alertcondition(wave3, "ç¬¬3æ³¢IN", "ç¬¬3æ³¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼")
