//@version=5
indicator("Pullback Buy v8.6 (Trend & Volume)", overlay=true, scale=scale.right, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. æˆ¦ç•¥ãƒ»æ„Ÿåº¦è¨­å®š
// ==========================================
group_strat = "ğŸ“Š æˆ¦ç•¥æ„Ÿåº¦è¨­å®š"
sensitivity = input.string("Lv3: Normal", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ„Ÿåº¦", options=["Lv1: Ultra Safe", "Lv2: Safe", "Lv3: Normal", "Lv4: Aggressive", "Lv5: Scalper"], group=group_strat)

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
var float s_zoneMult = na 
var float s_slMult = na 
var float s_tp1Mult = na

if sensitivity == "Lv1: Ultra Safe"
    s_zoneMult := 1.8, s_slMult := 1.5, s_tp1Mult := 1.0
else if sensitivity == "Lv2: Safe"
    s_zoneMult := 1.5, s_slMult := 1.2, s_tp1Mult := 0.9
else if sensitivity == "Lv3: Normal"
    s_zoneMult := 1.2, s_slMult := 1.0, s_tp1Mult := 0.8
else if sensitivity == "Lv4: Aggressive"
    s_zoneMult := 0.9, s_slMult := 0.8, s_tp1Mult := 0.7
else
    s_zoneMult := 0.6, s_slMult := 0.6, s_tp1Mult := 0.6

atrLen = input.int(14, "ATRæœŸé–“", group=group_strat)

// ==========================================
// 2. ãƒˆãƒ¬ãƒ³ãƒ‰ & ã‚¨ãƒ³ãƒˆãƒªãƒ¼è¨­å®š
// ==========================================
group_trend    = "ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
useTrendFilter = input.bool(true, "é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰é †å¼µã‚Šã®ã¿è¨±å¯", group=group_trend)
trendLen       = input.int(200,   "é•·æœŸEMAæœŸé–“", group=group_trend)
usePinbar      = input.bool(true, "ãƒ”ãƒ³ãƒãƒ¼æ—©æœŸã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ¹", group=group_trend)

group_filter   = "ğŸ›¡ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶"
useRSI         = input.bool(false, "RSIãƒ•ã‚£ãƒ«ã‚¿", group=group_filter)
rsiMin         = input.int(40,     "RSIä¸‹é™", group=group_filter)
cooldownPB     = input.int(5,      "PBé€£æ‰“é˜²æ­¢(æœ¬)", group=group_filter)
touchWindow    = input.int(120,    "ã‚¾ãƒ¼ãƒ³æ¥è§¦å¾Œã®æœ‰åŠ¹æœŸé–“", group=group_filter)

// ==========================================
// 3. å‡ºæ¥é«˜è¨­å®š (Volume Spike)
// ==========================================
group_vol      = "ğŸ”Š å‡ºæ¥é«˜æ¤œçŸ¥ (Volume)"
volLen         = input.int(20,     "å‡ºæ¥é«˜SMAæœŸé–“", group=group_vol)
volRatioTh     = input.float(1.5,  "æ€¥å¢—å€ç‡ã—ãã„å€¤", step=0.1, group=group_vol)
volNearK       = input.float(0.50, "VWAPè¿‘å‚åˆ¤å®š(ATRå€)", step=0.05, group=group_vol)
cooldownVol    = input.int(3,      "Volé€£æ‰“é˜²æ­¢(æœ¬)", minval=0, group=group_vol)

// ==========================================
// 4. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®š
// ==========================================
group_vis    = "ğŸ¨ è‰²ã¨è¡¨ç¤º"
showZones    = input.bool(true,  "è²·ã„ã‚¾ãƒ¼ãƒ³å¸¯ã‚’è¡¨ç¤º", group=group_vis)
showLines    = input.bool(true,  "TP/SLãƒ©ã‚¤ãƒ³ã‚’æç”»", group=group_vis)
c_zone       = input.color(color.new(color.green, 90), "ã‚¾ãƒ¼ãƒ³è‰²", group=group_vis)
c_sl         = input.color(color.red, "SLè‰²", group=group_vis)
c_tp         = input.color(color.blue, "TPè‰²", group=group_vis)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: å…±é€š
// ==========================================
float vwap_ = ta.vwap(hlc3)
float atr   = ta.atr(atrLen)
float rsi   = ta.rsi(close, 14)

// --- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š ---
float emaTrend = ta.ema(close, trendLen)
bool isUptrend = useTrendFilter ? (close > emaTrend) : true

// --- ã‚¾ãƒ¼ãƒ³è¨ˆç®— ---
float zoneHi = vwap_ - atr * (s_zoneMult * 0.40) 
float zoneLo = vwap_ - atr * (s_zoneMult)
bool  inZone = (low <= zoneHi and high >= zoneLo)

// --- æ¥è§¦å±¥æ­´ ---
var int lastTouch = na
if inZone
    lastTouch := bar_index
bool touchedRecently = not na(lastTouch) and (bar_index - lastTouch <= touchWindow)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Pullback Buy (PB)
// ==========================================
// A. VWAPä¸ŠæŠœã‘
bool crossUp = ta.crossover(close, vwap_)

// B. ãƒ”ãƒ³ãƒãƒ¼ï¼ˆä¸‹ãƒ’ã‚²ï¼‰
float bodySize  = math.abs(close - open)
float lowerWick = math.min(close, open) - low
bool isPinbar   = (lowerWick > bodySize * 2) and (close > open or (close - low) > (high - close))
bool pinbarSignal = usePinbar and inZone and isPinbar

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶
bool entrySignalRaw = (crossUp or pinbarSignal) and touchedRecently and isUptrend
bool rsiOK          = useRSI ? (rsi >= rsiMin) : true

// é€£æ‰“é˜²æ­¢
var int lastEntry = na
bool canEntry = na(lastEntry) or (bar_index - lastEntry >= cooldownPB)

// â˜…æœ€çµ‚PBã‚·ã‚°ãƒŠãƒ«
bool buySignal = entrySignalRaw and rsiOK and canEntry
if buySignal
    lastEntry := bar_index

// TP/SL è¨ˆç®—
float stopLvl = close - atr * s_slMult
float target1 = close + atr * s_tp1Mult

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Volume Spike (Vol)
// ==========================================
float volMA    = ta.sma(volume, volLen)
float volRatio = volume / math.max(volMA, 1)

// VWAPã«è¿‘ã„å ´æ‰€ã§ã®ã¿å‡ºæ¥é«˜æ¤œçŸ¥
bool nearVWAP  = math.abs(close - vwap_) <= atr * volNearK

// åˆ¤å®š
var int lastVol = na
bool volBase  = (volRatio >= volRatioTh) and nearVWAP
bool volSpike = volBase and (na(lastVol) or bar_index - lastVol >= cooldownVol)

if volSpike
    lastVol := bar_index

// â˜…ã‚³ãƒ³ãƒœåˆ¤å®š
bool isCombo = buySignal and volSpike

// ==========================================
// æç”» (Drawing)
// ==========================================
plot(vwap_, "VWAP", color=color.blue, linewidth=2)
plot(useTrendFilter ? emaTrend : na, "Trend EMA", color=color.gray, linewidth=2)

// Zone
p1 = plot(showZones ? zoneHi : na, "Zone Hi", color=na)
p2 = plot(showZones ? zoneLo : na, "Zone Lo", color=na)
fill(p1, p2, color=showZones and inZone ? c_zone : na)

// --- PB Markers ---
// Normal Buy (shape.triangleup ã‚’ä½¿ç”¨)
plotshape(buySignal and not isCombo, title="Buy", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.large, text="BUY", textcolor=color.white)

// Combo Buy (Strong) - (shape.diamond ã‚’ä½¿ç”¨)
plotshape(isCombo, title="Combo Buy", style=shape.diamond, location=location.belowbar, color=color.yellow, size=size.large, text="â˜…STRONG", textcolor=color.black)

// --- Vol Markers ---
plotshape(volSpike and not buySignal, title="Vol Spike", style=shape.circle, location=location.abovebar, size=size.tiny, color=color.navy, text="Vol", textcolor=color.navy)

// Lines
if showLines and buySignal
    line.new(bar_index, stopLvl, bar_index + 10, stopLvl, color=c_sl, style=line.style_dashed)
    line.new(bar_index, target1, bar_index + 10, target1, color=c_tp, style=line.style_dotted)

// Alerts
alertcondition(buySignal, "Pullback Buy", "PB Entry Detected")
alertcondition(volSpike,  "Volume Spike", "High Volume Detected")
alertcondition(isCombo,   "Combo Signal", "PB + Volume Spike Detected")
