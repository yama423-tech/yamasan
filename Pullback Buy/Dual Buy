/@version=5
indicator("Pullback Buy v8.6 + Dual Buy", overlay=true, scale=scale.right, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. æˆ¦ç•¥ãƒ»æ„Ÿåº¦è¨­å®š
// ==========================================
group_strat = "ğŸ“Š æˆ¦ç•¥æ„Ÿåº¦è¨­å®š"
sensitivity = input.string("Lv3: Normal", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ„Ÿåº¦", options=["Lv1: Ultra Safe", "Lv2: Safe", "Lv3: Normal", "Lv4: Aggressive", "Lv5: Scalper"], group=group_strat)

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
var float s_zoneMult = na 
var float s_slMult = na 
var float s_tp1Mult = na

if sensitivity == "Lv1: Ultra Safe"
    s_zoneMult := 1.8, s_slMult := 1.5, s_tp1Mult := 1.0
else if sensitivity == "Lv2: Safe"
    s_zoneMult := 1.5, s_slMult := 1.2, s_tp1Mult := 0.9
else if sensitivity == "Lv3: Normal"
    s_zoneMult := 1.2, s_slMult := 1.0, s_tp1Mult := 0.8
else if sensitivity == "Lv4: Aggressive"
    s_zoneMult := 0.9, s_slMult := 0.8, s_tp1Mult := 0.7
else
    s_zoneMult := 0.6, s_slMult := 0.6, s_tp1Mult := 0.6

atrLen = input.int(14, "ATRæœŸé–“", group=group_strat)

// ==========================================
// 2. ãƒˆãƒ¬ãƒ³ãƒ‰ & ã‚¨ãƒ³ãƒˆãƒªãƒ¼è¨­å®š
// ==========================================
group_trend    = "ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
useTrendFilter = input.bool(true, "é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰é †å¼µã‚Šã®ã¿è¨±å¯", group=group_trend)
trendLen       = input.int(200,   "é•·æœŸEMAæœŸé–“", group=group_trend)
usePinbar      = input.bool(true, "ãƒ”ãƒ³ãƒãƒ¼æ—©æœŸã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ¹", group=group_trend)

group_filter   = "ğŸ›¡ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶"
useRSI         = input.bool(false, "RSIãƒ•ã‚£ãƒ«ã‚¿", group=group_filter)
rsiMin         = input.int(40,     "RSIä¸‹é™", group=group_filter)
cooldownPB     = input.int(5,      "PBé€£æ‰“é˜²æ­¢(æœ¬)", group=group_filter)
touchWindow    = input.int(120,    "ã‚¾ãƒ¼ãƒ³æ¥è§¦å¾Œã®æœ‰åŠ¹æœŸé–“", group=group_filter)

// ==========================================
// 3. å‡ºæ¥é«˜è¨­å®š (Volume Spike)
// ==========================================
group_vol      = "ğŸ”Š å‡ºæ¥é«˜æ¤œçŸ¥ (Volume)"
volLen         = input.int(20,     "å‡ºæ¥é«˜SMAæœŸé–“", group=group_vol)
volRatioTh     = input.float(1.5,  "æ€¥å¢—å€ç‡ã—ãã„å€¤", step=0.1, group=group_vol)
volNearK       = input.float(0.50, "VWAPè¿‘å‚åˆ¤å®š(ATRå€)", step=0.05, group=group_vol)
cooldownVol    = input.int(3,      "Volé€£æ‰“é˜²æ­¢(æœ¬)", minval=0, group=group_vol)

// ==========================================
// â˜…æ–°è¦è¿½åŠ : Dual Buy (æ—¥è¶³é€£æº) è¨­å®š
// ==========================================
group_dual     = "ğŸŒŸ Dual Buy (æ—¥è¶³é€£æº)"
dailyTF        = input.timeframe("D", "é•·æœŸè¶³ï¼ˆæ—¥è¶³ï¼‰", group=group_dual)
d_fastLen      = input.int(20, "æ—¥è¶³: çŸ­æœŸMAæœŸé–“", group=group_dual)
d_slowLen      = input.int(50, "æ—¥è¶³: é•·æœŸMAæœŸé–“", group=group_dual)
// æ—¥è¶³Buyã®å®šç¾©: çŸ­æœŸMA > é•·æœŸMA (ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰) ã‹ã¤ ä¾¡æ ¼ > çŸ­æœŸMA (å‹¢ã„ã‚ã‚Š)

// ==========================================
// 4. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®š
// ==========================================
group_vis    = "ğŸ¨ è‰²ã¨è¡¨ç¤º"
showZones    = input.bool(true,  "è²·ã„ã‚¾ãƒ¼ãƒ³å¸¯ã‚’è¡¨ç¤º", group=group_vis)
showLines    = input.bool(true,  "TP/SLãƒ©ã‚¤ãƒ³ã‚’æç”»", group=group_vis)
c_zone       = input.color(color.new(color.green, 90), "ã‚¾ãƒ¼ãƒ³è‰²", group=group_vis)
c_sl         = input.color(color.red, "SLè‰²", group=group_vis)
c_tp         = input.color(color.blue, "TPè‰²", group=group_vis)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: å…±é€š
// ==========================================
float vwap_ = ta.vwap(hlc3)
float atr   = ta.atr(atrLen)
float rsi   = ta.rsi(close, 14)

// --- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š ---
float emaTrend = ta.ema(close, trendLen)
bool isUptrend = useTrendFilter ? (close > emaTrend) : true

// --- ã‚¾ãƒ¼ãƒ³è¨ˆç®— ---
float zoneHi = vwap_ - atr * (s_zoneMult * 0.40) 
float zoneLo = vwap_ - atr * (s_zoneMult)
bool  inZone = (low <= zoneHi and high >= zoneLo)

// --- æ¥è§¦å±¥æ­´ ---
var int lastTouch = na
if inZone
    lastTouch := bar_index
bool touchedRecently = not na(lastTouch) and (bar_index - lastTouch <= touchWindow)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Pullback Buy (PB)
// ==========================================
// A. VWAPä¸ŠæŠœã‘
bool crossUp = ta.crossover(close, vwap_)

// B. ãƒ”ãƒ³ãƒãƒ¼ï¼ˆä¸‹ãƒ’ã‚²ï¼‰
float bodySize  = math.abs(close - open)
float lowerWick = math.min(close, open) - low
bool isPinbar   = (lowerWick > bodySize * 2) and (close > open or (close - low) > (high - close))
bool pinbarSignal = usePinbar and inZone and isPinbar

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶
bool entrySignalRaw = (crossUp or pinbarSignal) and touchedRecently and isUptrend
bool rsiOK          = useRSI ? (rsi >= rsiMin) : true

// é€£æ‰“é˜²æ­¢
var int lastEntry = na
bool canEntry = na(lastEntry) or (bar_index - lastEntry >= cooldownPB)

// â˜…æœ€çµ‚PBã‚·ã‚°ãƒŠãƒ« (æ™‚é–“è¶³ã§ã®è²·ã„)
bool buySignal = entrySignalRaw and rsiOK and canEntry
if buySignal
    lastEntry := bar_index

// TP/SL è¨ˆç®—
float stopLvl = close - atr * s_slMult
float target1 = close + atr * s_tp1Mult

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Volume Spike (Vol)
// ==========================================
float volMA    = ta.sma(volume, volLen)
float volRatio = volume / math.max(volMA, 1)

// VWAPã«è¿‘ã„å ´æ‰€ã§ã®ã¿å‡ºæ¥é«˜æ¤œçŸ¥
bool nearVWAP  = math.abs(close - vwap_) <= atr * volNearK

// åˆ¤å®š
var int lastVol = na
bool volBase  = (volRatio >= volRatioTh) and nearVWAP
bool volSpike = volBase and (na(lastVol) or bar_index - lastVol >= cooldownVol)

if volSpike
    lastVol := bar_index

// â˜…Comboåˆ¤å®š (æ™‚é–“è¶³å†…ã§ã®å¼·ã‚·ã‚°ãƒŠãƒ«)
bool isCombo = buySignal and volSpike

// ==========================================
// â˜…Dual Buy è¨ˆç®— (æ—¥è¶³é€£æº)
// ==========================================
// æ—¥è¶³ã§ã®è²·ã„æ¡ä»¶ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°
check_daily_bullish() =>
    d_fast = ta.sma(close, d_fastLen)
    d_slow = ta.sma(close, d_slowLen)
    // æ¡ä»¶: æ—¥è¶³ãŒã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹(ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰)ä¸­ ã‹ã¤ æ—¥è¶³çµ‚å€¤ãŒçŸ­æœŸç·šã®ä¸Š
    (d_fast > d_slow) and (close > d_fast)

// æ—¥è¶³ãƒ‡ãƒ¼ã‚¿ã®å–å¾— (request.security)
bool isDailyBullish = request.security(syminfo.tickerid, dailyTF, check_daily_bullish())

// â˜…Dual Buyåˆ¤å®š
// æ™‚é–“è¶³ã§Buyã‚·ã‚°ãƒŠãƒ«ãŒå‡ºã¦ã€ã‹ã¤æ—¥è¶³ã‚‚ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ä¸­ã§ã‚ã‚‹
bool isDualBuy = buySignal and isDailyBullish

// ==========================================
// æç”» (Drawing)
// ==========================================
plot(vwap_, "VWAP", color=color.blue, linewidth=2)
plot(useTrendFilter ? emaTrend : na, "Trend EMA", color=color.gray, linewidth=2)

// Zone
p1 = plot(showZones ? zoneHi : na, "Zone Hi", color=na)
p2 = plot(showZones ? zoneLo : na, "Zone Lo", color=na)
fill(p1, p2, color=showZones and inZone ? c_zone : na)

// --- PB Markers ---

// 1. Dual Buy (æœ€å¼·: æ—¥è¶³ä¸Šæ˜‡ + æ™‚é–“è¶³æŠ¼ã—ç›®è²·ã„)
plotshape(isDualBuy, title="â˜… DUAL BUY", style=shape.labelup, location=location.belowbar, color=color.lime, textcolor=color.black, size=size.normal, text="DUAL\nBUY")

// 2. Normal Buy (æ™‚é–“è¶³ã®ã¿) - Dualã®æ™‚ã¯è¡¨ç¤ºã—ãªã„
plotshape(buySignal and not isDualBuy and not isCombo, title="Buy", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, text="Buy", textcolor=color.white)

// 3. Combo Buy (æ™‚é–“è¶³ + å‡ºæ¥é«˜) - Dualã®æ™‚ã¯Dualå„ªå…ˆ
plotshape(isCombo and not isDualBuy, title="Combo Buy", style=shape.diamond, location=location.belowbar, color=color.yellow, size=size.small, text="Strong", textcolor=color.black)

// --- Vol Markers ---
plotshape(volSpike and not buySignal, title="Vol Spike", style=shape.circle, location=location.abovebar, size=size.tiny, color=color.navy, text="Vol", textcolor=color.navy)

// Lines
if showLines and buySignal
    line.new(bar_index, stopLvl, bar_index + 10, stopLvl, color=c_sl, style=line.style_dashed)
    line.new(bar_index, target1, bar_index + 10, target1, color=c_tp, style=line.style_dotted)

// èƒŒæ™¯è‰²å¤‰æ›´ (Dual Buyæ™‚)
bgcolor(isDualBuy ? color.new(color.lime, 90) : na)

// Alerts
alertcondition(buySignal, "Pullback Buy (Any)", "PB Entry Detected")
alertcondition(isDualBuy, "â˜… Dual Buy Alert", "Daily Trend + Intraday PB Detected!")
alertcondition(volSpike,  "Volume Spike", "High Volume Detected")
