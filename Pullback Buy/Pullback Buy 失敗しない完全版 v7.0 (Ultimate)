//@version=6
indicator("Pullback Buy å¤±æ•—ã—ãªã„å®Œå…¨ç‰ˆ v7.0 (Ultimate)", overlay=true, scale=scale.right, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. æ„Ÿåº¦ãƒ»æˆ¦ç•¥è¨­å®š (Strategy Sensitivity)
// ==========================================
group_strat = "ğŸ“Š æˆ¦ç•¥æ„Ÿåº¦è¨­å®š"
sensitivity = input.string("Lv3: Normal", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ„Ÿåº¦", options=["Lv1: Ultra Safe", "Lv2: Safe", "Lv3: Normal", "Lv4: Aggressive", "Lv5: Scalper"], group=group_strat, tooltip="LvãŒä½ã„ã»ã©æ·±ã„æŠ¼ã—ç›®ï¼†åºƒã„ã‚¹ãƒˆãƒƒãƒ—ï¼ˆå‹ç‡é‡è¦–ï¼‰ã€‚\nLvãŒé«˜ã„ã»ã©æµ…ã„æŠ¼ã—ç›®ï¼†ç‹­ã„ã‚¹ãƒˆãƒƒãƒ—ï¼ˆå›è»¢é‡è¦–ï¼‰ã€‚")

// æ„Ÿåº¦ã«å¿œã˜ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°
var float s_zoneMult = na  // ã‚¾ãƒ¼ãƒ³ã®æ·±ã•ä¿‚æ•°
var float s_slMult   = na  // ã‚¹ãƒˆãƒƒãƒ—å¹…ä¿‚æ•°
var float s_tp1Mult  = na  // TP1å¹…ä¿‚æ•°

if sensitivity == "Lv1: Ultra Safe"
    s_zoneMult := 1.8, s_slMult := 1.5, s_tp1Mult := 1.0
else if sensitivity == "Lv2: Safe"
    s_zoneMult := 1.5, s_slMult := 1.2, s_tp1Mult := 0.9
else if sensitivity == "Lv3: Normal"
    s_zoneMult := 1.2, s_slMult := 1.0, s_tp1Mult := 0.8
else if sensitivity == "Lv4: Aggressive"
    s_zoneMult := 0.9, s_slMult := 0.8, s_tp1Mult := 0.7
else // Lv5
    s_zoneMult := 0.6, s_slMult := 0.6, s_tp1Mult := 0.6

// æ—¢å­˜ã®å…¥åŠ›ï¼ˆå¾®èª¿æ•´ç”¨ï¼‰
atrLen       = input.int(14,     "ATRæœŸé–“ (ãƒ™ãƒ¼ã‚¹)", minval=5, group=group_strat)
useVWAP      = input.bool(true,  "VWAPã‚’åŸºæº–ã«ã™ã‚‹", group=group_strat)

// ==========================================
// 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š (Filters)
// ==========================================
group_filter = "ğŸ›¡ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶"
useGapFilter = input.bool(false, "ã‚®ãƒ£ãƒƒãƒ—æ¡ä»¶ï¼ˆæ±ºç®—ç¿Œæ—¥ç­‰ï¼‰", group=group_filter)
minGap       = input.float(0.5,  "æœ€å°ã‚®ãƒ£ãƒƒãƒ—(%)", step=0.1, group=group_filter)
maxGap       = input.float(6.0,  "æœ€å¤§ã‚®ãƒ£ãƒƒãƒ—(%)", step=0.1, group=group_filter)

usePrevHigh  = input.bool(false, "å‰æ—¥é«˜å€¤ã‚ˆã‚Šä¸Šã®ã¿è¨±å¯", group=group_filter)
useRSI       = input.bool(false, "RSIãƒ•ã‚£ãƒ«ã‚¿", group=group_filter)
rsiLen       = input.int(14,     "RSIæœŸé–“", group=group_filter)
rsiMin       = input.int(40,     "RSIä¸‹é™", group=group_filter)
useRR        = input.bool(false, "ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰(RR)ãƒ•ã‚£ãƒ«ã‚¿", group=group_filter)
rrMin        = input.float(1.2,  "æœ€ä½RR (TP1/SL)", group=group_filter)

// åˆ¶å¾¡ç³»
firstPBOnly  = input.bool(false, "å¯„ã‚Šä»˜ãå¾Œã€æœ€åˆã®1å›ã®ã¿", group=group_filter)
cooldownPB   = input.int(5,      "é€£æ‰“é˜²æ­¢ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœ¬æ•°ï¼‰", minval=0, group=group_filter)
touchWindow  = input.int(120,    "ã‚¾ãƒ¼ãƒ³æ¥è§¦å¾Œã®æœ‰åŠ¹æœŸé–“(æœ¬)", minval=5, maxval=240, group=group_filter)

// ==========================================
// 3. å‡ºæ¥é«˜è¨­å®š (Volume)
// ==========================================
group_vol    = "ğŸ”Š å‡ºæ¥é«˜æ¤œçŸ¥"
volLen       = input.int(20,     "å‡ºæ¥é«˜SMAæœŸé–“", group=group_vol)
volRatioTh   = input.float(1.5,  "æ€¥å¢—å€ç‡ã—ãã„å€¤", step=0.1, group=group_vol)
volNearK     = input.float(0.50, "VWAPè¿‘å‚åˆ¤å®š(ATRå€)", step=0.05, group=group_vol)
volWindowMin = input.int(240,    "å¯„ã‚Šå¾Œæœ‰åŠ¹æ™‚é–“(åˆ†/0=çµ‚æ—¥)", minval=0, group=group_vol)
cooldownVol  = input.int(3,      "Volã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœ¬æ•°", minval=0, group=group_vol)

// ==========================================
// 4. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»è‰²è¨­å®š (Visuals)
// ==========================================
group_vis    = "ğŸ¨ è‰²ã¨è¡¨ç¤ºã®èª¿æ•´"
showZones    = input.bool(true,  "è²·ã„ã‚¾ãƒ¼ãƒ³å¸¯ã‚’è¡¨ç¤º", group=group_vis)
showTargets  = input.bool(true,  "ç¾åœ¨ã®TP/SLã‚’è¡¨ç¤º", group=group_vis)
showLines    = input.bool(true,  "ã‚·ã‚°ãƒŠãƒ«æ™‚ã®TP/SLãƒ©ã‚¤ãƒ³ã‚’æ®‹ã™", group=group_vis, tooltip="éå»ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä½ç½®ã®TP/SLã‚’ãƒ©ã‚¤ãƒ³æç”»ã—ã¾ã™")
showMarkers  = input.bool(true,  "ãƒãƒ¼ã‚«ãƒ¼ï¼ˆPB/Volï¼‰ã‚’è¡¨ç¤º", group=group_vis)

// è‰²è¨­å®š
c_zone       = input.color(color.green, "ã‚¾ãƒ¼ãƒ³è‰²", group=group_vis)
t_zone       = input.int(90, "ã‚¾ãƒ¼ãƒ³é€æ˜åº¦(0-100)", minval=0, maxval=100, group=group_vis)
c_tp         = input.color(color.orange, "åˆ©ç¢º(TP)è‰²", group=group_vis)
c_sl         = input.color(color.red,    "æåˆ‡(SL)è‰²", group=group_vis)
c_txt        = input.color(color.white,  "ãƒ©ãƒ™ãƒ«æ–‡å­—è‰²", group=group_vis)

lightMode    = input.bool(false, "è»½é‡è¡¨ç¤ºï¼ˆãƒ©ãƒ™ãƒ«æŠ‘åˆ¶ï¼‰", group=group_vis)
debug        = input.bool(false, "ãƒ‡ãƒãƒƒã‚°ï¼ˆå´ä¸‹ç†ç”±ã‚’è¡¨ç¤ºï¼‰", group=group_vis)

// Alerts
group_alert  = "ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š"
alertPB      = input.bool(true,  "ã‚¢ãƒ©ãƒ¼ãƒˆï¼šPullback Buy", group=group_alert)
alertVol     = input.bool(true,  "ã‚¢ãƒ©ãƒ¼ãƒˆï¼šVolume Spike", group=group_alert)
alertCombo   = input.bool(true,  "ã‚¢ãƒ©ãƒ¼ãƒˆï¼šPB+Vol åŒæ™‚", group=group_alert)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (Calculation)
// ==========================================
float vwap_     = ta.vwap(hlc3)
float atr       = ta.atr(atrLen)
float volMA     = ta.sma(volume, volLen)
float volRatio  = volume / math.max(volMA, 1)
float rsi       = ta.rsi(close, rsiLen)

// ---- ã‚®ãƒ£ãƒƒãƒ— ----
bool  firstBar  = session.isfirstbar
float prevCloseD = request.security(syminfo.tickerid, "D", close[1], gaps=barmerge.gaps_off)
float gapNow    = (open - prevCloseD) / math.max(prevCloseD, 1e-9) * 100
var   float gapPct = na
gapPct := firstBar ? gapNow : gapPct[1]
bool gapOK = useGapFilter ? (not na(gapPct) and gapPct >= minGap and gapPct <= maxGap) : true

// ---- æ™‚é–“çµŒé ----
var int sessStart = na
if session.isfirstbar
    sessStart := time
int minsFromOpen = na(sessStart) ? 0 : int((time - sessStart) / 60000)

// ---- å‰æ—¥é«˜ ----
float yHigh = request.security(syminfo.tickerid, "D", high[1], gaps=barmerge.gaps_off)
bool prevHighOK = usePrevHigh ? (close > yHigh) : true

// ========= ã‚¾ãƒ¼ãƒ³åˆ¤å®š (æ„Ÿåº¦è¨­å®šã‚’ä½¿ç”¨) =========
// ã‚¾ãƒ¼ãƒ³ã®ä¸Šé™ãƒ»ä¸‹é™è¨ˆç®—
float zoneHi = vwap_ - atr * (s_zoneMult * 0.40) 
float zoneLo = vwap_ - atr * (s_zoneMult)

bool  inZone = (low <= zoneHi and high >= zoneLo)

// ç›´è¿‘æ¥è§¦ç®¡ç†
var int lastTouch = na
if inZone
    lastTouch := bar_index
bool touchedRecently = not na(lastTouch) and (bar_index - lastTouch <= touchWindow)

// ========= PBåˆ¤å®š =========
bool crossUp     = ta.crossover(close, vwap_)
bool rsiOK       = useRSI ? (rsi >= rsiMin) : true
bool pbRaw       = touchedRecently and crossUp and rsiOK and gapOK and prevHighOK

// RR ã¨ã‚¹ãƒˆãƒƒãƒ—ï¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ (æ„Ÿåº¦è¨­å®šã‚’ä½¿ç”¨)
float stopLvl  = close - atr * s_slMult
float target1  = close + atr * s_tp1Mult
float target2  = close + atr * (s_tp1Mult * 2.0)

float rrNow    = (target1 - close) / math.max(close - stopLvl, syminfo.mintick)
bool rrOK      = useRR ? (rrNow >= rrMin) : true

// PB å®Ÿæˆ¦ãƒ•ã‚£ãƒ«ã‚¿
string reason = ""
bool   pullbackBuy = pbRaw and rrOK

// å¯„ã‚Šå¾Œ1ç™ºã ã‘
if firstPBOnly
    var bool firstDone = false
    if firstBar
        firstDone := false
    if pullbackBuy and firstDone
        pullbackBuy := false, reason := "firstOnly"
    if pullbackBuy and not firstDone
        firstDone := true

// ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
var int lastPB = na
bool canPB = na(lastPB) or (bar_index - lastPB >= cooldownPB)
if pullbackBuy and not canPB
    pullbackBuy := false, reason := "cooldown"
if pullbackBuy
    lastPB := bar_index

// å´ä¸‹ç†ç”±ã®ç‰¹å®š
if not pbRaw
    reason := not touchedRecently ? "noTouch" :
              not crossUp        ? "noCross" :
              useRSI and not rsiOK ? "rsi" :
              useGapFilter and not gapOK ? "gap" :
              usePrevHigh and not prevHighOK ? "prevHigh" :
              useRR and not rrOK ? "rr" : reason

// ========= Volume Spike =========
bool nearVWAP = math.abs(close - vwap_) <= atr * volNearK
bool inVolWin = volWindowMin == 0 ? true : (minsFromOpen <= volWindowMin)
var  int lastVol = na
bool volBase  = (volRatio >= volRatioTh) and nearVWAP and inVolWin and gapOK
bool volSpike = volBase and (na(lastVol) or bar_index - lastVol >= cooldownVol)
if volSpike
    lastVol := bar_index

bool combo = pullbackBuy and volSpike

// ==========================================
// æç”» (Drawing)
// ==========================================
// VWAP
plot(vwap_, "VWAP", color=color.new(color.blue, 0), linewidth=2)

// Zone (é€æ˜åº¦ã‚’é©ç”¨)
p_zHi = plot(showZones ? zoneHi : na, "Zone Hi", color=color.new(c_zone, t_zone), style=plot.style_linebr)
p_zLo = plot(showZones ? zoneLo : na, "Zone Lo", color=color.new(c_zone, t_zone), style=plot.style_linebr)
fill(p_zHi, p_zLo, color=showZones and inZone ? color.new(c_zone, t_zone) : na)

// Current TP/SL (ç¾åœ¨ã®ãƒãƒ¼ã®ã¿)
plot(showTargets ? target1 : na, "Target1", color=color.new(c_tp, 30), style=plot.style_circles)
plot(showTargets ? stopLvl : na, "Stop",    color=color.new(c_sl, 30), style=plot.style_circles)

// PB Markers
plotshape(showMarkers and pullbackBuy, title="PB Entry", style=shape.triangleup, location=location.belowbar,
          size=size.large, color=c_zone, text="BUY", textcolor=c_txt)

// Vol Markers
plotshape(showMarkers and volSpike,    title="Vol Spike", style=shape.circle,     location=location.abovebar,
          size=size.tiny,  color=color.new(color.blue, 0), text="Vol")

// Debug Label
if debug and not lightMode and (not pullbackBuy) and reason != ""
    label.new(bar_index, low, "Ã—:"+reason, yloc=yloc.belowbar, style=label.style_label_up, textcolor=c_txt, color=color.new(color.red, 50), size=size.small)

// --- NEW: ã‚·ã‚°ãƒŠãƒ«æ™‚ã®TP/SLãƒ©ã‚¤ãƒ³æç”» ---
if showLines and pullbackBuy
    // Stop Line
    line.new(bar_index, stopLvl, bar_index + 10, stopLvl, color=color.new(c_sl, 30), style=line.style_dashed)
    // TP1 Line
    line.new(bar_index, target1, bar_index + 10, target1, color=color.new(c_tp, 30), style=line.style_dotted)
    // Entry Marker Line (Optional: short horizontal at close)
    // line.new(bar_index, close, bar_index+3, close, color=color.gray)

// Alerts
alertcondition(alertPB    ? pullbackBuy : false, title="Pullback Buy",  message="PB: Entry Signal")
alertcondition(alertVol   ? volSpike    : false, title="Volume Spike",  message="Vol: Volume Spike")
alertcondition(alertCombo ? combo       : false, title="PB+Vol Combo",  message="Combo: PB & Vol Spike")
