//@version=5
indicator("Pullback Buy v9.1 Strict Edition", overlay=true, scale=scale.right, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. æˆ¦ç•¥ãƒ»æ„Ÿåº¦è¨­å®š
// ==========================================
group_strat = "ğŸ“Š æˆ¦ç•¥æ„Ÿåº¦è¨­å®š"

// å¤‰æ›´ç‚¹: å…¨ä½“çš„ã«åŸºæº–ã‚’å¤§å¹…ã«å³æ ¼åŒ–
// Lv01ï½Lv03ã¯ã€Œæš´è½ãƒ»æ€¥è½ã€æ™‚å°‚ç”¨ãƒ¬ãƒ™ãƒ«
sensitivity = input.string("Lv07: Normal", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ„Ÿåº¦", options=[
  "Lv01: Crisis Hunter",   // ç•°å¸¸å€¤ãƒ¬ãƒ™ãƒ«ï¼ˆå¤§æš´è½ç”¨ï¼‰
  "Lv02: Deep Bottom",     // ã‹ãªã‚Šæ·±ã„æŠ¼ã—ç›®
  "Lv03: Iron Fortress",   // å‰å›ã®Lv01ç›¸å½“
  "Lv04: Very Safe", 
  "Lv05: Safe Plus", 
  "Lv06: Safe", 
  "Lv07: Normal",          // é€šå¸¸ã‚ˆã‚Šå°‘ã—å³ã—ã‚
  "Lv08: Moderate", 
  "Lv09: Active", 
  "Lv10: Aggressive"
  ], group=group_strat)

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
var float s_zoneMult = na 
var float s_slMult = na 
var float s_tp1Mult = na

// ãƒ­ã‚¸ãƒƒã‚¯: å³ã—ã•ã‚’å¼·åŒ–ï¼ˆZoneMultã‚’æ‹¡å¤§ï¼‰
if sensitivity == "Lv01: Crisis Hunter"
    // ç•°å¸¸äº‹æ…‹ï¼ˆã€‡ã€‡ã‚·ãƒ§ãƒƒã‚¯ç´šï¼‰ã‚„æ±ºç®—æš´è½ã®ãƒªãƒã‚¦ãƒ³ãƒ‰ç‹™ã„
    s_zoneMult := 3.5, s_slMult := 2.5, s_tp1Mult := 2.0
else if sensitivity == "Lv02: Deep Bottom"
    // æ˜ç¢ºãªãƒ‘ãƒ‹ãƒƒã‚¯å£²ã‚ŠãŒç™ºç”Ÿã—ãŸæ°´æº–
    s_zoneMult := 3.0, s_slMult := 2.2, s_tp1Mult := 1.8
else if sensitivity == "Lv03: Iron Fortress"
    // ä»¥å‰ã®æœ€å¼·ãƒ¬ãƒ™ãƒ«ã€‚ã‹ãªã‚Šå …ã„
    s_zoneMult := 2.6, s_slMult := 2.0, s_tp1Mult := 1.5
else if sensitivity == "Lv04: Very Safe"
    s_zoneMult := 2.3, s_slMult := 1.8, s_tp1Mult := 1.3
else if sensitivity == "Lv05: Safe Plus"
    s_zoneMult := 2.0, s_slMult := 1.6, s_tp1Mult := 1.2
else if sensitivity == "Lv06: Safe"
    s_zoneMult := 1.8, s_slMult := 1.5, s_tp1Mult := 1.1
else if sensitivity == "Lv07: Normal"
    // ã“ã“ãŒæ¨™æº–ã ãŒã€ä»¥å‰ã®Safeç›¸å½“ã¾ã§å¼•ãç· ã‚
    s_zoneMult := 1.5, s_slMult := 1.3, s_tp1Mult := 1.0
else if sensitivity == "Lv08: Moderate"
    s_zoneMult := 1.2, s_slMult := 1.1, s_tp1Mult := 0.9
else if sensitivity == "Lv09: Active"
    s_zoneMult := 1.0, s_slMult := 0.9, s_tp1Mult := 0.8
else 
    // Lv10: Aggressive (ä»¥å‰ã®Normalï½Aggressiveç›¸å½“)
    s_zoneMult := 0.8, s_slMult := 0.8, s_tp1Mult := 0.7

atrLen = input.int(14, "ATRæœŸé–“", group=group_strat)

// ==========================================
// 2. ãƒˆãƒ¬ãƒ³ãƒ‰ & ã‚¨ãƒ³ãƒˆãƒªãƒ¼è¨­å®š
// ==========================================
group_trend    = "ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
useTrendFilter = input.bool(true, "é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰é †å¼µã‚Šã®ã¿è¨±å¯", group=group_trend)
trendLen       = input.int(200,   "é•·æœŸEMAæœŸé–“", group=group_trend)
usePinbar      = input.bool(true, "ãƒ”ãƒ³ãƒãƒ¼æ—©æœŸã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ¹", group=group_trend)

group_filter   = "ğŸ›¡ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶"
useRSI         = input.bool(false, "RSIãƒ•ã‚£ãƒ«ã‚¿", group=group_filter)
rsiMin         = input.int(40,     "RSIä¸‹é™", group=group_filter)
cooldownPB     = input.int(5,      "PBé€£æ‰“é˜²æ­¢(æœ¬)", group=group_filter)
touchWindow    = input.int(120,    "ã‚¾ãƒ¼ãƒ³æ¥è§¦å¾Œã®æœ‰åŠ¹æœŸé–“", group=group_filter)

// ==========================================
// 3. å‡ºæ¥é«˜è¨­å®š (Volume Spike)
// ==========================================
group_vol      = "ğŸ”Š å‡ºæ¥é«˜æ¤œçŸ¥ (Volume)"
volLen         = input.int(20,     "å‡ºæ¥é«˜SMAæœŸé–“", group=group_vol)
volRatioTh     = input.float(1.5,  "æ€¥å¢—å€ç‡ã—ãã„å€¤", step=0.1, group=group_vol)
volNearK       = input.float(0.50, "VWAPè¿‘å‚åˆ¤å®š(ATRå€)", step=0.05, group=group_vol)
cooldownVol    = input.int(3,      "Volé€£æ‰“é˜²æ­¢(æœ¬)", minval=0, group=group_vol)

// ==========================================
// â˜…Dual Buy (æ—¥è¶³é€£æº) è¨­å®š
// ==========================================
group_dual     = "ğŸŒŸ Dual Buy (æ—¥è¶³é€£æº)"
dailyTF        = input.timeframe("D", "é•·æœŸè¶³ï¼ˆæ—¥è¶³ï¼‰", group=group_dual)
d_fastLen      = input.int(20, "æ—¥è¶³: çŸ­æœŸMAæœŸé–“", group=group_dual)
d_slowLen      = input.int(50, "æ—¥è¶³: é•·æœŸMAæœŸé–“", group=group_dual)

// ==========================================
// 4. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®š
// ==========================================
group_vis    = "ğŸ¨ è‰²ã¨è¡¨ç¤º"
showZones    = input.bool(true,  "è²·ã„ã‚¾ãƒ¼ãƒ³å¸¯ã‚’è¡¨ç¤º", group=group_vis)
showLines    = input.bool(true,  "TP/SLãƒ©ã‚¤ãƒ³ã‚’æç”»", group=group_vis)
c_zone       = input.color(color.new(color.green, 90), "ã‚¾ãƒ¼ãƒ³è‰²", group=group_vis)
c_sl         = input.color(color.red, "SLè‰²", group=group_vis)
c_tp         = input.color(color.blue, "TPè‰²", group=group_vis)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: å…±é€š
// ==========================================
float vwap_ = ta.vwap(hlc3)
float atr   = ta.atr(atrLen)
float rsi   = ta.rsi(close, 14)

// --- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š ---
float emaTrend = ta.ema(close, trendLen)
bool isUptrend = useTrendFilter ? (close > emaTrend) : true

// --- ã‚¾ãƒ¼ãƒ³è¨ˆç®— ---
// å³ã—ã•ã‚¢ãƒƒãƒ—ã®ãŸã‚ã€ZoneHiï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼é–‹å§‹ä½ç½®ï¼‰ã‚‚å°‘ã—æ·±ãèª¿æ•´
float zoneHi = vwap_ - atr * (s_zoneMult * 0.50) 
float zoneLo = vwap_ - atr * (s_zoneMult * 1.2) // ä¸‹é™ã‚‚æ‹¡å¼µ
bool  inZone = (low <= zoneHi and high >= zoneLo)

// --- æ¥è§¦å±¥æ­´ ---
var int lastTouch = na
if inZone
    lastTouch := bar_index
bool touchedRecently = not na(lastTouch) and (bar_index - lastTouch <= touchWindow)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Pullback Buy (PB)
// ==========================================
// A. VWAPä¸ŠæŠœã‘
bool crossUp = ta.crossover(close, vwap_)

// B. ãƒ”ãƒ³ãƒãƒ¼ï¼ˆä¸‹ãƒ’ã‚²ï¼‰
float bodySize  = math.abs(close - open)
float lowerWick = math.min(close, open) - low
bool isPinbar   = (lowerWick > bodySize * 2) and (close > open or (close - low) > (high - close))
bool pinbarSignal = usePinbar and inZone and isPinbar

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶
bool entrySignalRaw = (crossUp or pinbarSignal) and touchedRecently and isUptrend
bool rsiOK          = useRSI ? (rsi >= rsiMin) : true

// é€£æ‰“é˜²æ­¢
var int lastEntry = na
bool canEntry = na(lastEntry) or (bar_index - lastEntry >= cooldownPB)

// â˜…æœ€çµ‚PBã‚·ã‚°ãƒŠãƒ« (æ™‚é–“è¶³ã§ã®è²·ã„)
bool buySignal = entrySignalRaw and rsiOK and canEntry
if buySignal
    lastEntry := bar_index

// TP/SL è¨ˆç®—
float stopLvl = close - atr * s_slMult
float target1 = close + atr * s_tp1Mult

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Volume Spike (Vol)
// ==========================================
float volMA    = ta.sma(volume, volLen)
float volRatio = volume / math.max(volMA, 1)
bool nearVWAP  = math.abs(close - vwap_) <= atr * volNearK
var int lastVol = na
bool volBase   = (volRatio >= volRatioTh) and nearVWAP
bool volSpike = volBase and (na(lastVol) or bar_index - lastVol >= cooldownVol)
if volSpike
    lastVol := bar_index

// â˜…Comboåˆ¤å®š
bool isCombo = buySignal and volSpike

// ==========================================
// â˜…Dual Buy è¨ˆç®— (æ—¥è¶³é€£æº)
// ==========================================
check_daily_bullish() =>
    d_fast = ta.sma(close, d_fastLen)
    d_slow = ta.sma(close, d_slowLen)
    (d_fast > d_slow) and (close > d_fast)

bool isDailyBullish = request.security(syminfo.tickerid, dailyTF, check_daily_bullish())
bool isDualBuy = buySignal and isDailyBullish

// ==========================================
// æç”» (Drawing)
// ==========================================
plot(vwap_, "VWAP", color=color.blue, linewidth=2)
plot(useTrendFilter ? emaTrend : na, "Trend EMA", color=color.gray, linewidth=2)

// Zone
p1 = plot(showZones ? zoneHi : na, "Zone Hi", color=na)
p2 = plot(showZones ? zoneLo : na, "Zone Lo", color=na)
fill(p1, p2, color=showZones and inZone ? c_zone : na)

// --- PB Markers ---
plotshape(isDualBuy, title="â˜… DUAL BUY", style=shape.labelup, location=location.belowbar, color=color.lime, textcolor=color.black, size=size.normal, text="DUAL\nBUY")
plotshape(buySignal and not isDualBuy and not isCombo, title="Buy", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, text="Buy", textcolor=color.white)
plotshape(isCombo and not isDualBuy, title="Combo Buy", style=shape.diamond, location=location.belowbar, color=color.yellow, size=size.small, text="Strong", textcolor=color.black)
plotshape(volSpike and not buySignal, title="Vol Spike", style=shape.circle, location=location.abovebar, size=size.tiny, color=color.navy, text="Vol", textcolor=color.navy)

// Lines
if showLines and buySignal
    line.new(bar_index, stopLvl, bar_index + 10, stopLvl, color=c_sl, style=line.style_dashed)
    line.new(bar_index, target1, bar_index + 10, target1, color=c_tp, style=line.style_dotted)

bgcolor(isDualBuy ? color.new(color.lime, 90) : na)

alertcondition(buySignal, "Pullback Buy (Any)", "PB Entry Detected")
alertcondition(isDualBuy, "â˜… Dual Buy Alert", "Daily Trend + Intraday PB Detected!")
alertcondition(volSpike,  "Volume Spike", "High Volume Detected")
