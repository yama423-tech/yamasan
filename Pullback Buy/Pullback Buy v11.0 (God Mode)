//@version=5
indicator("Pullback Buy v11.0 (God Mode)", overlay=true, scale=scale.right, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. æˆ¦ç•¥ãƒ»æ„Ÿåº¦è¨­å®š
// ==========================================
group_strat = "ðŸ“Š æˆ¦ç•¥æ„Ÿåº¦è¨­å®š"
sensitivity = input.string("Lv0: Sniper", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ„Ÿåº¦", options=["Lv0: Sniper", "Lv1: Super Safe", "Lv2: Ultra Safe", "Lv3: Safe", "Lv4: Normal"], group=group_strat)

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆLv0ã¯ã•ã‚‰ã«åŽ³æ ¼åŒ–ï¼‰
var float s_zoneMult = na 
var float s_slMult = na 
var float s_tp1Mult = na
var int   s_reqScore = na 

if sensitivity == "Lv0: Sniper"
    s_zoneMult := 2.5, s_slMult := 1.5, s_tp1Mult := 1.5, s_reqScore := 8 // å…¨8è¦ç´ å¿…é ˆ(ADX+Angleè¿½åŠ )
else if sensitivity == "Lv1: Super Safe"
    s_zoneMult := 2.0, s_slMult := 1.5, s_tp1Mult := 1.2, s_reqScore := 6
else if sensitivity == "Lv2: Ultra Safe"
    s_zoneMult := 1.8, s_slMult := 1.4, s_tp1Mult := 1.0, s_reqScore := 5
else if sensitivity == "Lv3: Safe"
    s_zoneMult := 1.5, s_slMult := 1.2, s_tp1Mult := 0.9, s_reqScore := 4
else 
    s_zoneMult := 1.2, s_slMult := 1.0, s_tp1Mult := 0.8, s_reqScore := 3

atrLen = input.int(20, "ATRæœŸé–“ (å®‰å®šå¿—å‘)", group=group_strat)

// ==========================================
// 2. æŒ‡æ¨™è¨­å®š
// ==========================================
group_ind = "ðŸ“ˆ åŽ³é¸ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°"
weeklyEmaLen = input.int(52,  "é€±è¶³ EMA", group=group_ind)
dailyEmaLen  = input.int(200, "æ—¥è¶³ EMA", group=group_ind)
maLen        = input.int(200, "åŸ·è¡Œè¶³ EMA (æŽ¨å¥¨:200)", group=group_ind)
volLen       = input.int(20,  "å‡ºæ¥é«˜ SMA", group=group_ind)
volTh        = input.float(2.0, "å‡ºæ¥é«˜æ€¥å¢—å€çŽ‡ (åŽ³æ ¼)", step=0.1, group=group_ind)

// ã€NEWã€‘å‹çŽ‡å‘ä¸Šã®ãŸã‚ã®æ–°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
useAdx       = input.bool(true, "ADXãƒ•ã‚£ãƒ«ã‚¿ (ãƒˆãƒ¬ãƒ³ãƒ‰ç™ºç”Ÿä¸­ã®ã¿)", group=group_ind)
adxTh        = input.int(25,    "ADXã—ãã„å€¤", group=group_ind)
useAngle     = input.bool(true, "EMAè§’åº¦ãƒ•ã‚£ãƒ«ã‚¿ (ä¸Šæ˜‡ä¸­ã®ã¿)", group=group_ind)

// ==========================================
// 3. ãƒ‡ãƒ¼ã‚¿å‡¦ç†
// ==========================================
float vwap_ = ta.vwap(hlc3)
float atr   = ta.atr(atrLen)
float rsi   = ta.rsi(close, 14)
float ema   = ta.ema(close, maLen)

// --- MACD ---
[macdLine, signalLine, hist] = ta.macd(close, 12, 26, 9)
bool macdBull = macdLine > signalLine

// --- Volume ---
float volMA = ta.sma(volume, volLen)
bool volSpike = volume > volMA * volTh

// --- ã€NEWã€‘ADX (ãƒˆãƒ¬ãƒ³ãƒ‰å¼·åº¦) ---
[diplus, diminus, adxVal] = ta.dmi(14, 14)
bool cond_Adx = useAdx ? (adxVal > adxTh) : true

// --- ã€NEWã€‘EMA Angle (è§’åº¦åˆ¤å®š) ---
// 3æœ¬å‰ã‚ˆã‚Šç¾åœ¨ã®EMAãŒé«˜ã„ï¼ä¸Šå‘ã
bool cond_Angle = useAngle ? (ema > ema[3]) : true

// --- MTF Data ---
float d_close = request.security(syminfo.tickerid, "D", close)
float d_ema   = request.security(syminfo.tickerid, "D", ta.ema(close, dailyEmaLen))
float d_rsi   = request.security(syminfo.tickerid, "D", ta.rsi(close, 14))
float w_close = request.security(syminfo.tickerid, "W", close)
float w_ema   = request.security(syminfo.tickerid, "W", ta.ema(close, weeklyEmaLen))

// ==========================================
// 4. åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (8-Point Scoring)
// ==========================================
bool cond_TrendW = (w_close > w_ema)
bool cond_TrendD = (d_close > d_ema) and (d_rsi < 80)
bool cond_MA     = (close > ema)
bool cond_MACD   = macdBull or (hist > hist[1] and hist < 0)
bool cond_RSI    = (rsi >= 45 and rsi <= 70) // ç¯„å›²ã‚’å°‘ã—ç‹­ã‚ã¦ç²¾åº¦å‘ä¸Š
bool cond_Vol    = volSpike

// --- ã‚¾ãƒ¼ãƒ³è¨ˆç®— ---
float zoneHi = vwap_ - atr * (s_zoneMult * 0.40) 
float zoneLo = vwap_ - atr * (s_zoneMult)
bool  inZone = (low <= zoneHi and high >= zoneLo)

// --- ãƒˆãƒªã‚¬ãƒ¼ ---
bool candleBull = close > open
bool triggerRaw = (ta.crossover(close, vwap_) or (inZone and candleBull))

// --- ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° ---
int score = 0
string reasons = ""

if cond_TrendW 
    score += 1
    reasons += "W-Trend "
if cond_TrendD 
    score += 1
    reasons += "D-Trend "
if cond_MA
    score += 1
    reasons += "MA "
if cond_MACD
    score += 1
    reasons += "MACD "
if cond_RSI
    score += 1
    reasons += "RSI "
if cond_Vol
    score += 1
    reasons += "Vol "
if cond_Adx        // æ–°è¦ç´ 
    score += 1
    reasons += "ADX "
if cond_Angle      // æ–°è¦ç´ 
    score += 1
    reasons += "Angle "

// --- æœ€çµ‚ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆ¤å®š ---
// Lv0 Sniperã¯å…¨è¦ç´ (8ç‚¹)å¿…é ˆ
bool strictTrend = (sensitivity == "Lv0: Sniper") ? (cond_TrendW and cond_TrendD and cond_Angle and cond_Adx) : true
bool isEntry = triggerRaw and strictTrend and (score >= s_reqScore)

// é€£æ‰“é˜²æ­¢
var int lastEntry = na
if isEntry and (not na(lastEntry) and bar_index - lastEntry < 5)
    isEntry := false
if isEntry
    lastEntry := bar_index

// TP/SL
float stopLvl = close - atr * s_slMult
float target1 = close + atr * s_tp1Mult

// ==========================================
// 5. æç”»
// ==========================================
plot(vwap_, "VWAP", color=color.new(color.blue, 50))
plot(ema,   "Exec EMA", color=color.new(color.orange, 30), linewidth=2)

// Signal
plotshape(isEntry, title="ENTRY", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.large, text="GOD IN", textcolor=color.white)

// Label (é€ã‘ã‚‹èƒŒæ™¯)
if isEntry
    label_text = "âš¡ GOD MODE\n" + reasons + "\nScore: " + str.tostring(score) + "/8"
    label.new(bar_index, low - atr*1.5, label_text, style=label.style_label_up, color=color.new(color.green, 85), textcolor=color.new(color.white, 10), size=size.normal)

// Lines
if isEntry
    line.new(bar_index, stopLvl, bar_index + 10, stopLvl, color=color.new(color.red, 30), style=line.style_dashed)
    line.new(bar_index, target1, bar_index + 10, target1, color=color.new(color.blue, 30), style=line.style_dotted)

alertcondition(isEntry, "Entry Signal", "God Mode Entry")
