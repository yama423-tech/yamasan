//@version=6
indicator("Pullback Buy v10.0 Precision Edition (ADX+MACD)", overlay=true, scale=scale.right, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. Êà¶Áï•„ÉªÊÑüÂ∫¶Ë®≠ÂÆö
// ==========================================
group_strat = "üìä Êà¶Áï•ÊÑüÂ∫¶Ë®≠ÂÆö"

sensitivity = input.string("Lv07: Normal", "„Ç®„É≥„Éà„É™„ÉºÊÑüÂ∫¶", options=[
  "Lv01: Crisis Hunter", 
  "Lv02: Deep Bottom", 
  "Lv03: Iron Fortress", 
  "Lv04: Very Safe", 
  "Lv05: Safe Plus", 
  "Lv06: Safe", 
  "Lv07: Normal", 
  "Lv08: Moderate", 
  "Lv09: Active", 
  "Lv10: Aggressive"
  ], group=group_strat)

// „Éë„É©„É°„Éº„Çø„Éû„ÉÉ„Éî„É≥„Ç∞
var float s_zoneMult = na 
var float s_slMult = na 
var float s_tp1Mult = na

if sensitivity == "Lv01: Crisis Hunter"
    s_zoneMult := 3.5, s_slMult := 2.5, s_tp1Mult := 2.0
else if sensitivity == "Lv02: Deep Bottom"
    s_zoneMult := 3.0, s_slMult := 2.2, s_tp1Mult := 1.8
else if sensitivity == "Lv03: Iron Fortress"
    s_zoneMult := 2.6, s_slMult := 2.0, s_tp1Mult := 1.5
else if sensitivity == "Lv04: Very Safe"
    s_zoneMult := 2.3, s_slMult := 1.8, s_tp1Mult := 1.3
else if sensitivity == "Lv05: Safe Plus"
    s_zoneMult := 2.0, s_slMult := 1.6, s_tp1Mult := 1.2
else if sensitivity == "Lv06: Safe"
    s_zoneMult := 1.8, s_slMult := 1.5, s_tp1Mult := 1.1
else if sensitivity == "Lv07: Normal"
    s_zoneMult := 1.5, s_slMult := 1.3, s_tp1Mult := 1.0
else if sensitivity == "Lv08: Moderate"
    s_zoneMult := 1.2, s_slMult := 1.1, s_tp1Mult := 0.9
else if sensitivity == "Lv09: Active"
    s_zoneMult := 1.0, s_slMult := 0.9, s_tp1Mult := 0.8
else 
    s_zoneMult := 0.8, s_slMult := 0.8, s_tp1Mult := 0.7

atrLen = input.int(14, "ATRÊúüÈñì", group=group_strat)

// ==========================================
// 2. „Éà„É¨„É≥„Éâ & „Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö (Âº∑ÂåñÁâà)
// ==========================================
group_trend    = "üìà „Éà„É¨„É≥„Éâ„Éï„Ç£„É´„Çø„Éº (Á≤æÂ∫¶Âº∑Âåñ)"
useTrendFilter = input.bool(true, "Èï∑Êúü„Éà„É¨„É≥„Éâ(EMA200)È†ÜÂºµ„Çä„ÅÆ„Åø", group=group_trend)
trendLen       = input.int(200,   "Èï∑ÊúüEMAÊúüÈñì", group=group_trend)

// ‚òÖ ADX„Éï„Ç£„É´„Çø„Éº (New)
useAdxFilter   = input.bool(true, "ADX„Éï„Ç£„É´„Çø„Éº„Çí‰ΩøÁî® („É¨„É≥„Ç∏ÂõûÈÅø)", group=group_trend)
adxTh          = input.int(20,    "ADX„Åó„Åç„ÅÑÂÄ§ (20‰ª•‰∏äÊé®Â•®)", group=group_trend)

group_filter   = "üõ°Ô∏è „Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂"
useRSI         = input.bool(true, "RSI„Éï„Ç£„É´„Çø (Ë≤∑„Çè„Çå„Åô„ÅéÈò≤Ê≠¢)", group=group_filter)
rsiMin         = input.int(40,    "RSI‰∏ãÈôê („Åì„Çå‰ª•‰∏ä„ÅßË≤∑„ÅÑ)", group=group_filter)
rsiMax         = input.int(75,    "RSI‰∏äÈôê („Åì„Çå‰ª•‰∏ã„ÅßË≤∑„ÅÑ)", group=group_filter)
cooldownPB     = input.int(5,     "PBÈÄ£ÊâìÈò≤Ê≠¢(Êú¨)", group=group_filter)
touchWindow    = input.int(120,   "„Çæ„Éº„É≥Êé•Ëß¶Âæå„ÅÆÊúâÂäπÊúüÈñì", group=group_filter)

// ==========================================
// 3. Âá∫Êù•È´òË®≠ÂÆö (Volume Spike)
// ==========================================
group_vol      = "üîä Âá∫Êù•È´òÊ§úÁü• (Volume)"
volLen         = input.int(20,     "Âá∫Êù•È´òSMAÊúüÈñì", group=group_vol)
volRatioTh     = input.float(1.5,  "ÊÄ•Â¢óÂÄçÁéá„Åó„Åç„ÅÑÂÄ§", step=0.1, group=group_vol)
volNearK       = input.float(0.50, "VWAPËøëÂÇçÂà§ÂÆö(ATRÂÄç)", step=0.05, group=group_vol)
cooldownVol    = input.int(3,      "VolÈÄ£ÊâìÈò≤Ê≠¢(Êú¨)", minval=0, group=group_vol)

// ==========================================
// ‚òÖDual Buy (Êó•Ë∂≥ÈÄ£Êê∫) Ë®≠ÂÆö
// ==========================================
group_dual     = "üåü Dual Buy (Êó•Ë∂≥ÈÄ£Êê∫)"
dailyTF        = input.timeframe("D", "Èï∑ÊúüË∂≥ÔºàÊó•Ë∂≥Ôºâ", group=group_dual)
d_fastLen      = input.int(20, "Êó•Ë∂≥: Áü≠ÊúüMAÊúüÈñì", group=group_dual)
d_slowLen      = input.int(50, "Êó•Ë∂≥: Èï∑ÊúüMAÊúüÈñì", group=group_dual)

// ==========================================
// 4. „Éì„Ç∏„É•„Ç¢„É´Ë®≠ÂÆö
// ==========================================
group_vis    = "üé® Ëâ≤„Å®Ë°®Á§∫"
showZones    = input.bool(true,  "Ë≤∑„ÅÑ„Çæ„Éº„É≥Â∏Ø„ÇíË°®Á§∫", group=group_vis)
showLines    = input.bool(true,  "TP/SL„É©„Ç§„É≥„ÇíÊèèÁîª", group=group_vis)
c_zone       = input.color(color.new(color.green, 90), "„Çæ„Éº„É≥Ëâ≤", group=group_vis)
c_sl         = input.color(color.red, "SLËâ≤", group=group_vis)
c_tp         = input.color(color.blue, "TPËâ≤", group=group_vis)
showMonitor  = input.bool(true, "WTP„É¢„Éã„Çø„Éº„ÇíË°®Á§∫", group=group_vis)

// „É¢„Éã„Çø„ÉºËâ≤
c_panelBg    = color.rgb(32, 35, 45)
c_header     = color.rgb(56, 44, 125)
c_grayTxt    = color.rgb(165, 173, 189)
c_ok         = color.lime
c_ng         = color.red

// ==========================================
// Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ: Âü∫Êú¨ÊåáÊ®ô
// ==========================================
float vwap_ = ta.vwap(hlc3)
float atr   = ta.atr(atrLen)
float rsi   = ta.rsi(close, 14)

// --- „Éà„É¨„É≥„ÉâÂà§ÂÆö (EMA) ---
float emaTrend = ta.ema(close, trendLen)
bool isUptrend = useTrendFilter ? (close > emaTrend) : true

// --- ‚òÖ ADXÂà§ÂÆö („Éà„É¨„É≥„ÉâÂº∑Â∫¶) ---
[diplus, diminus, adxValue] = ta.dmi(14, 14)
bool isAdxStrong = useAdxFilter ? (adxValue >= adxTh) : true

// --- „Çæ„Éº„É≥Ë®àÁÆó ---
float zoneHi = vwap_ - atr * (s_zoneMult * 0.50) 
float zoneLo = vwap_ - atr * (s_zoneMult * 1.2) 
bool  inZone = (low <= zoneHi and high >= zoneLo)

// --- Êé•Ëß¶Â±•Ê≠¥ ---
var int lastTouch = na
if inZone
    lastTouch := bar_index
bool touchedRecently = not na(lastTouch) and (bar_index - lastTouch <= touchWindow)

// ==========================================
// Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ: Pullback Buy (PB)
// ==========================================
// A. VWAP‰∏äÊäú„Åë
bool crossUp = ta.crossover(close, vwap_)

// B. „Éî„É≥„Éê„ÉºÔºà‰∏ã„Éí„Ç≤Ôºâ
float bodySize  = math.abs(close - open)
float lowerWick = math.min(close, open) - low
bool isPinbar   = (lowerWick > bodySize * 2) and (close > open or (close - low) > (high - close))
// „Éî„É≥„Éê„ÉºÊù°‰ª∂: „Çæ„Éº„É≥ÂÜÖ „Åæ„Åü„ÅØ VWAP‰ªòËøë
bool pinbarSignal = (inZone or (math.abs(low - vwap_) < atr * 0.5)) and isPinbar

// „Ç®„É≥„Éà„É™„ÉºÊù°‰ª∂ÔºàÁîüÔºâ
bool entrySignalRaw = (crossUp or pinbarSignal) and touchedRecently and isUptrend

// RSI„Éï„Ç£„É´„Çø„Éº (‰∏äÈôê„Éª‰∏ãÈôê)
bool rsiOK = useRSI ? (rsi >= rsiMin and rsi <= rsiMax) : true

// ÈÄ£ÊâìÈò≤Ê≠¢
var int lastEntry = na
bool canEntry = na(lastEntry) or (bar_index - lastEntry >= cooldownPB)

// ==========================================
// ‚òÖ ÊîπËâØ: MACDÂà§ÂÆö (12, 26, 9)
// ==========================================
[macdLine, macdSig, macdHist] = ta.macd(close, 12, 26, 9)

// ‰ª•Ââç: ta.crossover(macdLine, macdSig) -> ÁÇπ„Åß„Åó„ÅãÂèçÂøú„Åó„Å™„ÅÑ
// ‰ªäÂõû: „Éí„Çπ„Éà„Ç∞„É©„É†„ÅåÂ¢óÂä†‰∏≠Ôºà„É¢„É°„É≥„Çø„É†Â•ΩËª¢Ôºâ „Åã„Å§ „Éû„Ç§„Éä„ÇπÂúè„Åã„Çâ„ÅÆÂõûÂæ© or „Ç¥„Éº„É´„Éá„É≥„ÇØ„É≠„Çπ‰∏≠
bool macdImproving = (macdHist > macdHist[1]) and (macdHist[1] < macdHist[2] or macdHist > 0)
// „Åæ„Åü„ÅØ„ÄÅÂçòÁ¥î„Å´„Ç¥„Éº„É´„Éá„É≥„ÇØ„É≠„Çπ„Åó„Åü„Å∞„Åã„Çä
bool macdCross = ta.crossover(macdLine, macdSig)

// MACDÁ∑èÂêàÂà§ÂÆö: „ÇØ„É≠„Çπ„Åó„Åü„Åã„ÄÅ„Éí„Çπ„Éà„Ç∞„É©„É†„ÅåÂ•ΩËª¢„Åó„Å¶„ÅÑ„Çã„Åã
bool macdConfirm = macdImproving or macdCross

// ==========================================
// ‚òÖÊúÄÁµÇPB„Ç∑„Ç∞„Éä„É´ (È´òÁ≤æÂ∫¶Áâà)
// ==========================================
// Êù°‰ª∂: Áîü„Ç∑„Ç∞„Éä„É´ + RSIÈÅ©Ê≠£ + ÈÄ£ÊâìÈò≤Ê≠¢ + MACDÂ•ΩËª¢ + ADX„Éà„É¨„É≥„ÉâÂº∑Â∫¶
bool buySignal = entrySignalRaw and rsiOK and canEntry and macdConfirm and isAdxStrong

if buySignal
    lastEntry := bar_index

// TP/SL Ë®àÁÆó
float stopLvl = close - atr * s_slMult
float target1 = close + atr * s_tp1Mult

// ==========================================
// Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ: Volume Spike (Vol)
// ==========================================
float volMA    = ta.sma(volume, volLen)
float volRatio = volume / math.max(volMA, 1)
bool nearVWAP  = math.abs(close - vwap_) <= atr * volNearK
var int lastVol = na
bool volBase   = (volRatio >= volRatioTh) and nearVWAP
bool volSpike = volBase and (na(lastVol) or bar_index - lastVol >= cooldownVol)
if volSpike
    lastVol := bar_index

// ‚òÖComboÂà§ÂÆö
bool isCombo = buySignal and volSpike

// ==========================================
// ‚òÖDual Buy Ë®àÁÆó (Êó•Ë∂≥ÈÄ£Êê∫)
// ==========================================
check_daily_bullish() =>
    d_fast = ta.sma(close, d_fastLen)
    d_slow = ta.sma(close, d_slowLen)
    // ‰ªäÂõû„ÅÆÊîπËâØ: Êó•Ë∂≥„ÇÇ‰∏äÊòá„Éà„É¨„É≥„ÉâÁ¢∫ÂÆöÊôÇ„ÅÆ„Åø (fast > slow)
    (d_fast > d_slow) and (close > d_fast)

bool isDailyBullish = request.security(syminfo.tickerid, dailyTF, check_daily_bullish())
bool isDualBuy = buySignal and isDailyBullish

// ==========================================
// ÊèèÁîª (Drawing)
// ==========================================
plot(vwap_, "VWAP", color=color.blue, linewidth=2)
plot(useTrendFilter ? emaTrend : na, "Trend EMA", color=color.gray, linewidth=2)

// Zone
p1 = plot(showZones ? zoneHi : na, "Zone Hi", color=na)
p2 = plot(showZones ? zoneLo : na, "Zone Lo", color=na)
fill(p1, p2, color=showZones and inZone ? c_zone : na)

// --- PB Markers ---
// Ë°®Á§∫ÂÑ™ÂÖàÂ∫¶: Dual > Combo > Normal
plotshape(isDualBuy, title="‚òÖ DUAL BUY", style=shape.labelup, location=location.belowbar, color=color.lime, textcolor=color.black, size=size.normal, text="DUAL\nBUY")
plotshape(isCombo and not isDualBuy, title="Combo Buy", style=shape.diamond, location=location.belowbar, color=color.yellow, size=size.small, text="Strong", textcolor=color.black)
plotshape(buySignal and not isDualBuy and not isCombo, title="Buy", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, text="Buy", textcolor=color.white)
plotshape(volSpike and not buySignal, title="Vol Spike", style=shape.circle, location=location.abovebar, size=size.tiny, color=color.navy, text="Vol", textcolor=color.navy)

// Lines
if showLines and buySignal
    line.new(bar_index, stopLvl, bar_index + 10, stopLvl, color=c_sl, style=line.style_dashed)
    line.new(bar_index, target1, bar_index + 10, target1, color=c_tp, style=line.style_dotted)

bgcolor(isDualBuy ? color.new(color.lime, 90) : na)

// „Ç¢„É©„Éº„Éà
alertcondition(buySignal, "PB v10 Entry", "Precision PB Entry Detected")
alertcondition(isDualBuy, "‚òÖ Dual Buy Alert", "Daily Trend + Intraday PB Detected!")
alertcondition(volSpike,  "Volume Spike", "High Volume Detected")


// ==========================================
// WTP Monitor (Âà•Ê∑ª„Ç§„É°„Éº„Ç∏È¢®„É©„Éô„É´)
// ==========================================
statusTxt = isDualBuy ? "Dual Buy" : isCombo ? "Combo" : buySignal ? "Ë≤∑„ÅÑÂÄôË£ú" : "ÂæÖÊ©ü"
statusCol = isDualBuy or isCombo or buySignal ? c_ok : c_grayTxt

modeTxt = sensitivity
adxTxt = str.tostring(adxValue, "#.0") + (isAdxStrong ? " ‰∏äÊòá" : " Âº±")
volTxt = str.tostring(volRatio, "#.1") + "x"
macdTxt = macdConfirm ? "‚úî" : "‚úñ"
breakTxt = crossUp ? "‚úî" : "‚úñ"
bandWalk = close > zoneHi and rsi > 55
bandTxt = bandWalk ? "‚úî" : "‚úñ"
vwapJudge = close > vwap_
vwapTxt = vwapJudge ? "‚úî" : "‚úñ"

if showMonitor
    var table mon = table.new(position.top_right, 2, 11, bgcolor=c_panelBg, frame_color=color.new(color.white, 70), frame_width=1)
    if barstate.islast
        table.cell(mon, 0, 0, "WTP Monitor", text_color=color.white, bgcolor=c_header, text_size=size.small)
        table.cell(mon, 1, 0, "", text_color=color.white, bgcolor=c_header)

        table.cell(mon, 0, 1, "Status", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 1, statusTxt, text_color=statusCol, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 2, "Mode", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 2, modeTxt, text_color=color.white, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 3, "Êó•Ë∂≥Trend", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 3, isDailyBullish ? "‚úî" : "‚úñ", text_color=isDailyBullish ? c_ok : c_ng, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 4, "ADX(Âã¢„ÅÑ)", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 4, adxTxt, text_color=isAdxStrong ? c_ok : c_ng, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 5, "RSI", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 5, str.tostring(rsi, "#.1"), text_color=rsiOK ? color.white : c_ng, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 6, "VolÂÄçÁéá", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 6, volTxt, text_color=volSpike ? c_ok : c_grayTxt, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 7, "MACD", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 7, macdTxt, text_color=macdConfirm ? c_ok : c_ng, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 8, "Breakout", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 8, breakTxt, text_color=crossUp ? c_ok : c_ng, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 9, "BandWalk", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 9, bandTxt, text_color=bandWalk ? c_ok : c_ng, bgcolor=c_panelBg, text_size=size.small)

        table.cell(mon, 0, 10, "VWAPÂà§ÂÆö", text_color=c_grayTxt, bgcolor=c_panelBg, text_size=size.small)
        table.cell(mon, 1, 10, vwapTxt, text_color=vwapJudge ? c_ok : c_ng, bgcolor=c_panelBg, text_size=size.small)
