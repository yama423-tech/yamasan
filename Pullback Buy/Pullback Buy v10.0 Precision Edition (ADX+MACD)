//@version=5
indicator("Pullback Buy v10.0 Precision Edition (ADX+MACD)", overlay=true, scale=scale.right, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. æˆ¦ç•¥ãƒ»æ„Ÿåº¦è¨­å®š
// ==========================================
group_strat = "ğŸ“Š æˆ¦ç•¥æ„Ÿåº¦è¨­å®š"

sensitivity = input.string("Lv07: Normal", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ„Ÿåº¦", options=[
  "Lv01: Crisis Hunter", 
  "Lv02: Deep Bottom", 
  "Lv03: Iron Fortress", 
  "Lv04: Very Safe", 
  "Lv05: Safe Plus", 
  "Lv06: Safe", 
  "Lv07: Normal", 
  "Lv08: Moderate", 
  "Lv09: Active", 
  "Lv10: Aggressive"
  ], group=group_strat)

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
var float s_zoneMult = na 
var float s_slMult = na 
var float s_tp1Mult = na

if sensitivity == "Lv01: Crisis Hunter"
    s_zoneMult := 3.5, s_slMult := 2.5, s_tp1Mult := 2.0
else if sensitivity == "Lv02: Deep Bottom"
    s_zoneMult := 3.0, s_slMult := 2.2, s_tp1Mult := 1.8
else if sensitivity == "Lv03: Iron Fortress"
    s_zoneMult := 2.6, s_slMult := 2.0, s_tp1Mult := 1.5
else if sensitivity == "Lv04: Very Safe"
    s_zoneMult := 2.3, s_slMult := 1.8, s_tp1Mult := 1.3
else if sensitivity == "Lv05: Safe Plus"
    s_zoneMult := 2.0, s_slMult := 1.6, s_tp1Mult := 1.2
else if sensitivity == "Lv06: Safe"
    s_zoneMult := 1.8, s_slMult := 1.5, s_tp1Mult := 1.1
else if sensitivity == "Lv07: Normal"
    s_zoneMult := 1.5, s_slMult := 1.3, s_tp1Mult := 1.0
else if sensitivity == "Lv08: Moderate"
    s_zoneMult := 1.2, s_slMult := 1.1, s_tp1Mult := 0.9
else if sensitivity == "Lv09: Active"
    s_zoneMult := 1.0, s_slMult := 0.9, s_tp1Mult := 0.8
else 
    s_zoneMult := 0.8, s_slMult := 0.8, s_tp1Mult := 0.7

atrLen = input.int(14, "ATRæœŸé–“", group=group_strat)

// ==========================================
// 2. ãƒˆãƒ¬ãƒ³ãƒ‰ & ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š (å¼·åŒ–ç‰ˆ)
// ==========================================
group_trend    = "ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (ç²¾åº¦å¼·åŒ–)"
useTrendFilter = input.bool(true, "é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰(EMA200)é †å¼µã‚Šã®ã¿", group=group_trend)
trendLen       = input.int(200,   "é•·æœŸEMAæœŸé–“", group=group_trend)

// â˜… ADXãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (New)
useAdxFilter   = input.bool(true, "ADXãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ (ãƒ¬ãƒ³ã‚¸å›é¿)", group=group_trend)
adxTh          = input.int(20,    "ADXã—ãã„å€¤ (20ä»¥ä¸Šæ¨å¥¨)", group=group_trend)

group_filter   = "ğŸ›¡ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶"
useRSI         = input.bool(true, "RSIãƒ•ã‚£ãƒ«ã‚¿ (è²·ã‚ã‚Œã™ãé˜²æ­¢)", group=group_filter)
rsiMin         = input.int(40,    "RSIä¸‹é™ (ã“ã‚Œä»¥ä¸Šã§è²·ã„)", group=group_filter)
rsiMax         = input.int(75,    "RSIä¸Šé™ (ã“ã‚Œä»¥ä¸‹ã§è²·ã„)", group=group_filter)
cooldownPB     = input.int(5,     "PBé€£æ‰“é˜²æ­¢(æœ¬)", group=group_filter)
touchWindow    = input.int(120,   "ã‚¾ãƒ¼ãƒ³æ¥è§¦å¾Œã®æœ‰åŠ¹æœŸé–“", group=group_filter)

// ==========================================
// 3. å‡ºæ¥é«˜è¨­å®š (Volume Spike)
// ==========================================
group_vol      = "ğŸ”Š å‡ºæ¥é«˜æ¤œçŸ¥ (Volume)"
volLen         = input.int(20,     "å‡ºæ¥é«˜SMAæœŸé–“", group=group_vol)
volRatioTh     = input.float(1.5,  "æ€¥å¢—å€ç‡ã—ãã„å€¤", step=0.1, group=group_vol)
volNearK       = input.float(0.50, "VWAPè¿‘å‚åˆ¤å®š(ATRå€)", step=0.05, group=group_vol)
cooldownVol    = input.int(3,      "Volé€£æ‰“é˜²æ­¢(æœ¬)", minval=0, group=group_vol)

// ==========================================
// â˜…Dual Buy (æ—¥è¶³é€£æº) è¨­å®š
// ==========================================
group_dual     = "ğŸŒŸ Dual Buy (æ—¥è¶³é€£æº)"
dailyTF        = input.timeframe("D", "é•·æœŸè¶³ï¼ˆæ—¥è¶³ï¼‰", group=group_dual)
d_fastLen      = input.int(20, "æ—¥è¶³: çŸ­æœŸMAæœŸé–“", group=group_dual)
d_slowLen      = input.int(50, "æ—¥è¶³: é•·æœŸMAæœŸé–“", group=group_dual)

// ==========================================
// 4. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®š
// ==========================================
group_vis    = "ğŸ¨ è‰²ã¨è¡¨ç¤º"
showZones    = input.bool(true,  "è²·ã„ã‚¾ãƒ¼ãƒ³å¸¯ã‚’è¡¨ç¤º", group=group_vis)
showLines    = input.bool(true,  "TP/SLãƒ©ã‚¤ãƒ³ã‚’æç”»", group=group_vis)
c_zone       = input.color(color.new(color.green, 90), "ã‚¾ãƒ¼ãƒ³è‰²", group=group_vis)
c_sl         = input.color(color.red, "SLè‰²", group=group_vis)
c_tp         = input.color(color.blue, "TPè‰²", group=group_vis)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: åŸºæœ¬æŒ‡æ¨™
// ==========================================
float vwap_ = ta.vwap(hlc3)
float atr   = ta.atr(atrLen)
float rsi   = ta.rsi(close, 14)

// --- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š (EMA) ---
float emaTrend = ta.ema(close, trendLen)
bool isUptrend = useTrendFilter ? (close > emaTrend) : true

// --- â˜… ADXåˆ¤å®š (ãƒˆãƒ¬ãƒ³ãƒ‰å¼·åº¦) ---
[diplus, diminus, adxValue] = ta.dmi(14, 14)
bool isAdxStrong = useAdxFilter ? (adxValue >= adxTh) : true

// --- ã‚¾ãƒ¼ãƒ³è¨ˆç®— ---
float zoneHi = vwap_ - atr * (s_zoneMult * 0.50) 
float zoneLo = vwap_ - atr * (s_zoneMult * 1.2) 
bool  inZone = (low <= zoneHi and high >= zoneLo)

// --- æ¥è§¦å±¥æ­´ ---
var int lastTouch = na
if inZone
    lastTouch := bar_index
bool touchedRecently = not na(lastTouch) and (bar_index - lastTouch <= touchWindow)

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Pullback Buy (PB)
// ==========================================
// A. VWAPä¸ŠæŠœã‘
bool crossUp = ta.crossover(close, vwap_)

// B. ãƒ”ãƒ³ãƒãƒ¼ï¼ˆä¸‹ãƒ’ã‚²ï¼‰
float bodySize  = math.abs(close - open)
float lowerWick = math.min(close, open) - low
bool isPinbar   = (lowerWick > bodySize * 2) and (close > open or (close - low) > (high - close))
// ãƒ”ãƒ³ãƒãƒ¼æ¡ä»¶: ã‚¾ãƒ¼ãƒ³å†… ã¾ãŸã¯ VWAPä»˜è¿‘
bool pinbarSignal = (inZone or (math.abs(low - vwap_) < atr * 0.5)) and isPinbar

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶ï¼ˆç”Ÿï¼‰
bool entrySignalRaw = (crossUp or pinbarSignal) and touchedRecently and isUptrend

// RSIãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (ä¸Šé™ãƒ»ä¸‹é™)
bool rsiOK = useRSI ? (rsi >= rsiMin and rsi <= rsiMax) : true

// é€£æ‰“é˜²æ­¢
var int lastEntry = na
bool canEntry = na(lastEntry) or (bar_index - lastEntry >= cooldownPB)

// ==========================================
// â˜… æ”¹è‰¯: MACDåˆ¤å®š (12, 26, 9)
// ==========================================
[macdLine, macdSig, macdHist] = ta.macd(close, 12, 26, 9)

// ä»¥å‰: ta.crossover(macdLine, macdSig) -> ç‚¹ã§ã—ã‹åå¿œã—ãªã„
// ä»Šå›: ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãŒå¢—åŠ ä¸­ï¼ˆãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ å¥½è»¢ï¼‰ ã‹ã¤ ãƒã‚¤ãƒŠã‚¹åœã‹ã‚‰ã®å›å¾© or ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹ä¸­
bool macdImproving = (macdHist > macdHist[1]) and (macdHist[1] < macdHist[2] or macdHist > 0)
// ã¾ãŸã¯ã€å˜ç´”ã«ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹ã—ãŸã°ã‹ã‚Š
bool macdCross = ta.crossover(macdLine, macdSig)

// MACDç·åˆåˆ¤å®š: ã‚¯ãƒ­ã‚¹ã—ãŸã‹ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãŒå¥½è»¢ã—ã¦ã„ã‚‹ã‹
bool macdConfirm = macdImproving or macdCross

// ==========================================
// â˜…æœ€çµ‚PBã‚·ã‚°ãƒŠãƒ« (é«˜ç²¾åº¦ç‰ˆ)
// ==========================================
// æ¡ä»¶: ç”Ÿã‚·ã‚°ãƒŠãƒ« + RSIé©æ­£ + é€£æ‰“é˜²æ­¢ + MACDå¥½è»¢ + ADXãƒˆãƒ¬ãƒ³ãƒ‰å¼·åº¦
bool buySignal = entrySignalRaw and rsiOK and canEntry and macdConfirm and isAdxStrong

if buySignal
    lastEntry := bar_index

// TP/SL è¨ˆç®—
float stopLvl = close - atr * s_slMult
float target1 = close + atr * s_tp1Mult

// ==========================================
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯: Volume Spike (Vol)
// ==========================================
float volMA    = ta.sma(volume, volLen)
float volRatio = volume / math.max(volMA, 1)
bool nearVWAP  = math.abs(close - vwap_) <= atr * volNearK
var int lastVol = na
bool volBase   = (volRatio >= volRatioTh) and nearVWAP
bool volSpike = volBase and (na(lastVol) or bar_index - lastVol >= cooldownVol)
if volSpike
    lastVol := bar_index

// â˜…Comboåˆ¤å®š
bool isCombo = buySignal and volSpike

// ==========================================
// â˜…Dual Buy è¨ˆç®— (æ—¥è¶³é€£æº)
// ==========================================
check_daily_bullish() =>
    d_fast = ta.sma(close, d_fastLen)
    d_slow = ta.sma(close, d_slowLen)
    // ä»Šå›ã®æ”¹è‰¯: æ—¥è¶³ã‚‚ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ç¢ºå®šæ™‚ã®ã¿ (fast > slow)
    (d_fast > d_slow) and (close > d_fast)

bool isDailyBullish = request.security(syminfo.tickerid, dailyTF, check_daily_bullish())
bool isDualBuy = buySignal and isDailyBullish

// ==========================================
// æç”» (Drawing)
// ==========================================
plot(vwap_, "VWAP", color=color.blue, linewidth=2)
plot(useTrendFilter ? emaTrend : na, "Trend EMA", color=color.gray, linewidth=2)

// Zone
p1 = plot(showZones ? zoneHi : na, "Zone Hi", color=na)
p2 = plot(showZones ? zoneLo : na, "Zone Lo", color=na)
fill(p1, p2, color=showZones and inZone ? c_zone : na)

// --- PB Markers ---
// è¡¨ç¤ºå„ªå…ˆåº¦: Dual > Combo > Normal
plotshape(isDualBuy, title="â˜… DUAL BUY", style=shape.labelup, location=location.belowbar, color=color.lime, textcolor=color.black, size=size.normal, text="DUAL\nBUY")
plotshape(isCombo and not isDualBuy, title="Combo Buy", style=shape.diamond, location=location.belowbar, color=color.yellow, size=size.small, text="Strong", textcolor=color.black)
plotshape(buySignal and not isDualBuy and not isCombo, title="Buy", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, text="Buy", textcolor=color.white)
plotshape(volSpike and not buySignal, title="Vol Spike", style=shape.circle, location=location.abovebar, size=size.tiny, color=color.navy, text="Vol", textcolor=color.navy)

// Lines
if showLines and buySignal
    line.new(bar_index, stopLvl, bar_index + 10, stopLvl, color=c_sl, style=line.style_dashed)
    line.new(bar_index, target1, bar_index + 10, target1, color=c_tp, style=line.style_dotted)

bgcolor(isDualBuy ? color.new(color.lime, 90) : na)

// ã‚¢ãƒ©ãƒ¼ãƒˆ
alertcondition(buySignal, "PB v10 Entry", "Precision PB Entry Detected")
alertcondition(isDualBuy, "â˜… Dual Buy Alert", "Daily Trend + Intraday PB Detected!")
alertcondition(volSpike,  "Volume Spike", "High Volume Detected")
