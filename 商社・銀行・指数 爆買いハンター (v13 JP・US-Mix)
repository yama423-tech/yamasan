//@version=6
indicator("å•†ç¤¾ãƒ»éŠ€è¡Œãƒ»æŒ‡æ•° çˆ†è²·ã„ãƒãƒ³ã‚¿ãƒ¼ (v13 JP/US-Mix)", overlay=true, shorttitle="Hunter Pro v13")

// ==========================================
// 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
// ==========================================

string target_group = input.string("Current Chart", "ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆç›£è¦–å¯¾è±¡", 
     options=[
         "Current Chart", 
         "--- 7å¤§å•†ç¤¾ ---",
         "Itochu (8001)", "Mitsubishi (8058)", "Mitsui (8031)", "Sumitomo (8053)", 
         "Marubeni (8002)", "Toyota Tsusho (8015)", "Sojitz (2768)",
         "--- ãƒ¡ã‚¬ãƒãƒ³ã‚¯ ---",
         "MUFG (8306)", "SMFG (8316)", "Mizuho (8411)",
         "--- æ—¥æœ¬ETF ---",
         "Nikkei 225 (ETF 1321)", "TOPIX (ETF 1306)",
         "--- ç±³å›½ETF/ETN ---",
         "FANG+ (ETN FNGS)", "S&P 500 (ETF SPY)", "Emerging (ETF EEM)", "India (ETF INDA)"
     ], group="ãƒ¡ã‚¤ãƒ³è¨­å®š", tooltip="æŒ‡æ•°é¸æŠæ™‚ã¯ãƒ‘ãƒãƒ«ï¼ˆè¡¨ï¼‰ã¯éè¡¨ç¤ºã«ãªã‚Šã¾ã™")

string sensitivity = input.string("Lv3 (Normal)", "æ„Ÿåº¦è¨­å®š (è²·ã„åˆ¤å®š)", 
     options=["Lv1 (Very Hard)", "Lv2 (Hard)", "Lv3 (Normal)", "Lv4 (Easy)", "Lv5 (Very Easy)"], 
     tooltip="Lv1: RSI<20\nLv5: RSI<40", group="ãƒ¡ã‚¤ãƒ³è¨­å®š")

// --- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ ---
bool is_debug = input.bool(false, "ğŸ›  è¡¨ç¤ºãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ (å¼·åˆ¶ç‚¹ç¯)", group="ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°", tooltip="ONã«ã™ã‚‹ã¨æ¡ä»¶ã‚’ç„¡è¦–ã—ã¦å¸¸ã«ã‚µã‚¤ãƒ³ã‚’å‡ºã—ã¾ã™ã€‚")

// --- ãƒ‘ãƒãƒ«è¨­å®š ---
bool show_table     = input.bool(true, "ç›£è¦–ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º (å•†ç¤¾ãƒ»éŠ€è¡Œã®ã¿)", group="ãƒ‘ãƒãƒ«è¨­å®š")
float spacer_h      = input.float(5.0, "ãƒ‘ãƒãƒ«ä½ç½®èª¿æ•´(Yè»¸ %)", minval=0.0, maxval=50.0, step=0.5, group="ãƒ‘ãƒãƒ«è¨­å®š")
string table_size   = input.string(size.small, "æ–‡å­—ã‚µã‚¤ã‚º", options=[size.tiny, size.small, size.normal, size.large, size.huge], group="ãƒ‘ãƒãƒ«è¨­å®š")

// ==========================================
// 2. ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
// ==========================================

string active_category = "7å¤§å•†ç¤¾"
if str.contains(target_group, "MUFG") or str.contains(target_group, "SMFG") or str.contains(target_group, "Mizuho") or str.contains(target_group, "ãƒ¡ã‚¬ãƒãƒ³ã‚¯")
    active_category := "ãƒ¡ã‚¬ãƒãƒ³ã‚¯"
else if str.contains(target_group, "FANG+") or str.contains(target_group, "S&P") or str.contains(target_group, "Nikkei") or str.contains(target_group, "TOPIX") or str.contains(target_group, "Emerging") or str.contains(target_group, "India") or str.contains(target_group, "ETF")
    active_category := "ä¸»è¦æŒ‡æ•°"
else
    active_category := "7å¤§å•†ç¤¾"

// ==========================================
// 3. ãƒ­ã‚¸ãƒƒã‚¯å®šç¾©
// ==========================================

var float rsi_limit = 30.0
var float bb_dev    = 2.0

if is_debug
    rsi_limit := 100.0 // å¸¸ã«HIT
    bb_dev    := -10.0 // å¸¸ã«HIT
else
    if sensitivity == "Lv1 (Very Hard)"
        rsi_limit := 20.0
        bb_dev    := 2.4
    else if sensitivity == "Lv2 (Hard)"
        rsi_limit := 25.0
        bb_dev    := 2.2
    else if sensitivity == "Lv3 (Normal)"
        rsi_limit := 30.0
        bb_dev    := 2.0
    else if sensitivity == "Lv4 (Easy)"
        rsi_limit := 35.0
        bb_dev    := 1.8
    else if sensitivity == "Lv5 (Very Easy)"
        rsi_limit := 40.0
        bb_dev    := 1.6

f_get_data(string _t) =>
    [_c, _rsi, _basis, _dev] = request.security(_t, timeframe.period, [close, ta.rsi(close, 14), ta.sma(close, 20), ta.stdev(close, 20)])
    float _l_bb = _basis - (bb_dev * _dev)
    bool _is_buy = _c < _l_bb and _rsi < rsi_limit
    [_c, _rsi, _is_buy]

get_ticker(string name) =>
    string result = syminfo.tickerid
    switch name
        "Itochu (8001)"        => result := "TSE:8001"
        "Mitsubishi (8058)"    => result := "TSE:8058"
        "Mitsui (8031)"        => result := "TSE:8031"
        "Sumitomo (8053)"      => result := "TSE:8053"
        "Marubeni (8002)"      => result := "TSE:8002"
        "Toyota Tsusho (8015)" => result := "TSE:8015"
        "Sojitz (2768)"        => result := "TSE:2768"
        "MUFG (8306)"          => result := "TSE:8306"
        "SMFG (8316)"          => result := "TSE:8316"
        "Mizuho (8411)"        => result := "TSE:8411"
        
        // --- æ—¥æœ¬ ETF ---
        "Nikkei 225 (ETF 1321)" => result := "TSE:1321" // é‡æ‘æ—¥çµŒ225é€£å‹•å‹
        "TOPIX (ETF 1306)"      => result := "TSE:1306" // é‡æ‘TOPIXé€£å‹•å‹

        // --- ç±³å›½ ETF/ETN ---
        "FANG+ (ETN FNGS)"      => result := "NYSE:FNGS" // MicroSectors FANG+ ETN
        "S&P 500 (ETF SPY)"     => result := "AMEX:SPY"  // SPDR S&P 500 ETF Trust
        "Emerging (ETF EEM)"    => result := "AMEX:EEM"  // iShares MSCI Emerging Markets
        "India (ETF INDA)"      => result := "BATS:INDA" // iShares MSCI India ETF

        => result := syminfo.tickerid
    result

// ==========================================
// 4. ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆæç”»
// ==========================================

string target_ticker = get_ticker(target_group)
if str.contains(target_group, "---")
    target_ticker := syminfo.tickerid

[c, rsi_val, basis, dev] = request.security(target_ticker, timeframe.period, [close, ta.rsi(close, 14), ta.sma(close, 20), ta.stdev(close, 20)])
float lower_bb = basis - (bb_dev * dev)
bool is_oversold = c < lower_bb and rsi_val < rsi_limit

plot(target_group != "Current Chart" and not str.contains(target_group, "---") ? c : na, title="Selected Price", color=color.gray)
bgcolor(is_oversold ? color.new(color.yellow, 80) : na, title="Buy Signal Zone")

plotshape((not is_debug and is_oversold) ? low : na, title="BUY Mark", location=location.belowbar, color=color.red, style=shape.triangleup, size=size.small, text="BUY", textcolor=color.red)
plotshape((is_debug and is_oversold) ? low : na, title="TEST Mark", location=location.belowbar, color=color.orange, style=shape.triangleup, size=size.small, text="TEST", textcolor=color.orange)

// ==========================================
// 5. ãƒ‘ãƒãƒ«å‡¦ç†
// ==========================================

var string[] p_names = array.new_string(0)
var string[] p_tickers = array.new_string(0)

if barstate.isfirst
    array.clear(p_names)
    array.clear(p_tickers)
    
    // æŒ‡æ•°ã®æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—
    if active_category == "ä¸»è¦æŒ‡æ•°"
        na
    else if active_category == "7å¤§å•†ç¤¾"
        array.push(p_names, "ä¼Šè—¤å¿ "), array.push(p_tickers, "TSE:8001")
        array.push(p_names, "ä¸‰è±å•†"), array.push(p_tickers, "TSE:8058")
        array.push(p_names, "ä¸‰äº•ç‰©"), array.push(p_tickers, "TSE:8031")
        array.push(p_names, "ä½å‹å•†"), array.push(p_tickers, "TSE:8053")
        array.push(p_names, "ä¸¸ç´…"),   array.push(p_tickers, "TSE:8002")
        array.push(p_names, "è±Šé€š"),   array.push(p_tickers, "TSE:8015")
        array.push(p_names, "åŒæ—¥"),   array.push(p_tickers, "TSE:2768")
    else if active_category == "ãƒ¡ã‚¬ãƒãƒ³ã‚¯"
        array.push(p_names, "UFJ"),    array.push(p_tickers, "TSE:8306")
        array.push(p_names, "ä¸‰äº•ä½å‹"), array.push(p_tickers, "TSE:8316")
        array.push(p_names, "ã¿ãšã»"),  array.push(p_tickers, "TSE:8411")

if show_table and array.size(p_names) > 0
    var table tbl = table.new(position.top_right, 4, 10, bgcolor=color.new(color.black, 50), frame_color=color.white, frame_width=1)
    
    table.cell(tbl, 0, 0, "", height=spacer_h, bgcolor=color.new(color.black, 100))
    table.merge_cells(tbl, 0, 0, 3, 0)

    table.cell(tbl, 0, 1, active_category, text_color=color.white, text_size=table_size, bgcolor=color.new(color.blue, 60))
    table.cell(tbl, 1, 1, "ä¾¡æ ¼", text_color=color.white, text_size=table_size, bgcolor=color.new(color.blue, 60))
    table.cell(tbl, 2, 1, "RSI", text_color=color.white, text_size=table_size, bgcolor=color.new(color.blue, 60))
    table.cell(tbl, 3, 1, "åˆ¤å®š", text_color=color.white, text_size=table_size, bgcolor=color.new(color.blue, 60))

    for i = 0 to array.size(p_names) - 1
        string _n = array.get(p_names, i)
        string _t = array.get(p_tickers, i)
        
        [val_c, val_rsi, val_buy] = f_get_data(_t)
        
        color rsi_color = val_rsi < rsi_limit ? color.red : color.white
        color bg_color  = val_buy ? color.new(color.yellow, 30) : color.new(color.black, 60)
        
        string signal = "-"
        if val_buy
            if is_debug
                signal := "TEST"
            else
                signal := "â˜…è²·ã„"
        
        string price_str = na(val_c) ? "Wait" : str.tostring(val_c, format.mintick)
        string rsi_str   = na(val_rsi) ? "-" : str.tostring(val_rsi, "#.0")

        table.cell(tbl, 0, i+2, _n, text_color=color.white, bgcolor=bg_color, text_size=table_size)
        table.cell(tbl, 1, i+2, price_str, text_color=color.white, bgcolor=bg_color, text_size=table_size)
        table.cell(tbl, 2, i+2, rsi_str, text_color=rsi_color, bgcolor=bg_color, text_size=table_size)
        table.cell(tbl, 3, i+2, signal, text_color=color.yellow, bgcolor=bg_color, text_size=table_size)
