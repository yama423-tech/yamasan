//@version=6
indicator("Momentum & Divergence v7.0 (Ultimate)", overlay=true, scale=scale.right, max_lines_count=500, max_labels_count=500, max_bars_back=5000)

// ==========================================
// 1. ÊÑüÂ∫¶„ÉªÊà¶Áï•Ë®≠ÂÆö (Sensitivity Strategy)
// ==========================================
groupStrat = "üìä ÊÑüÂ∫¶„ÉªÊà¶Áï•Ë®≠ÂÆö"
sensitivity = input.string("Lv3: Normal", "ÊÑüÂ∫¶„É¨„Éô„É´", options=["Lv1: Scalper (Very Fast)", "Lv2: Fast", "Lv3: Normal", "Lv4: Strict", "Lv5: Swing (Solid)"], group=groupStrat, tooltip="Lv1: ÂèçÂøúÊó©„ÇÅ„Éª„ÉÄ„Éû„Ç∑„ÅÇ„ÇäÔºà„Çπ„Ç≠„É£„É´ÂêëÔºâ\nLv3: Ê®ôÊ∫ñ\nLv5: Á¢∫ÂÆüÊÄßÈáçË¶ñ„ÉªÈ†ªÂ∫¶‰ΩéÔºà„Çπ„Ç§„É≥„Ç∞ÂêëÔºâ")

// ÊÑüÂ∫¶„Éû„ÉÉ„Éî„É≥„Ç∞Ôºà„É¨„Éô„É´„Åî„Å®„ÅÆ„Éë„É©„É°„Éº„ÇøËá™ÂãïË®≠ÂÆöÔºâ
var int p_L = na, var int p_R = na, var int p_gap = na
var int p_rsiUp = na, var int p_rsiDn = na

if sensitivity == "Lv1: Scalper (Very Fast)"
    p_L := 2, p_R := 2, p_gap := 2, p_rsiUp := 52, p_rsiDn := 48
else if sensitivity == "Lv2: Fast"
    p_L := 4, p_R := 4, p_gap := 5, p_rsiUp := 54, p_rsiDn := 46
else if sensitivity == "Lv3: Normal"
    p_L := 6, p_R := 6, p_gap := 10, p_rsiUp := 55, p_rsiDn := 45
else if sensitivity == "Lv4: Strict"
    p_L := 10, p_R := 10, p_gap := 15, p_rsiUp := 58, p_rsiDn := 42
else // Lv5
    p_L := 20, p_R := 20, p_gap := 20, p_rsiUp := 60, p_rsiDn := 40

// „Ç´„Çπ„Çø„É†Ë™øÊï¥Ôºà‰∏äÁ¥öËÄÖÁî®Ôºâ
useCustom   = input.bool(false, "Ë©≥Á¥∞„Éë„É©„É°„Éº„Çø„ÇíÊâãÂãïË®≠ÂÆö„Åô„Çã", group=groupStrat)
src         = input.source(close, "‰æ°Ê†º„ÇΩ„Éº„Çπ", group=groupStrat)
rsiLen      = input.int(14, "RSIÊúüÈñì", minval=2, group=groupStrat)

// ÂÆüÈöõ„ÅÆÈÅ©Áî®ÂÄ§
L      = useCustom ? input.int(6, "Pivot Â∑¶", group=groupStrat) : p_L
R      = useCustom ? input.int(6, "Pivot Âè≥", group=groupStrat) : p_R
minGap = useCustom ? input.int(10,"PivotÈñìÈöî", group=groupStrat) : p_gap
rsiUp  = useCustom ? input.int(55, "RSIÂü∫Ê∫ñ(‰∏ä)", group=groupStrat) : p_rsiUp
rsiDn  = useCustom ? input.int(45, "RSIÂü∫Ê∫ñ(‰∏ã)", group=groupStrat) : p_rsiDn

// MACDË®≠ÂÆö
groupMACD = "MACDË®≠ÂÆö"
fast = input.int(12, "MACD Fast", group=groupMACD)
slow = input.int(26, "MACD Slow", group=groupMACD)
sig  = input.int(9,  "MACD Signal", group=groupMACD)

// ==========================================
// 2. „Éï„Ç£„É´„Çø„ÉªÁ¢∫ÂÆö„É≠„Ç∏„ÉÉ„ÇØ (Logic)
// ==========================================
groupVol = "Âá∫Êù•È´ò„Éï„Ç£„É´„Çø"
useVolFilt = input.bool(false, "Âá∫Êù•È´ò„Çπ„Éë„Ç§„ÇØ„Åß„Éï„Ç£„É´„Çø", group=groupVol)
volLen     = input.int(20, "Âá∫Êù•È´òSMAÊúüÈñì", minval=2, group=groupVol)
volMult    = input.float(1.5, "ÂÄçÁéá„Åó„Åç„ÅÑÂÄ§", minval=1.0, step=0.1, group=groupVol)

groupC = "Á¢∫ÂÆö„É≠„Ç∏„ÉÉ„ÇØ (Strict)"
useConfirm    = input.bool(false, "Á¢∫ÂÆö„Ç∑„Ç∞„Éä„É´(Confirmed)„ÇíË®àÁÆó", group=groupC)
useSwingBreak = input.bool(true,  "Êàª„ÇäÈ´òÂÄ§/ÂÆâÂÄ§„Éñ„É¨„Ç§„ÇØÂøÖÈ†à", group=groupC)
useMACDconf   = input.bool(true,  "MACD„ÇØ„É≠„Çπ/0„É©„Ç§„É≥ÂøÖÈ†à",    group=groupC)
useRSIconf    = input.bool(true,  "RSI>50/<50 ÂøÖÈ†à",           group=groupC)
useTrendFilt  = input.bool(true,  "EMA„Éà„É¨„É≥„ÉâÊù°‰ª∂",           group=groupC)
maLen         = input.int(200,    "EMAÊúüÈñì",                   group=groupC)
trendBars     = input.int(5,      "EMAÂêë„ÅçÁ¢∫Ë™çÊú¨Êï∞",           group=groupC)
useVolConf    = input.bool(false, "Âá∫Êù•È´ò„Çπ„Éë„Ç§„ÇØ„ÇÇÂøÖÈ†à",      group=groupC)

groupCombo   = "„Ç≥„É≥„ÉúÂà§ÂÆö (MOM √ó Div)"
useComboBull = input.bool(true,  "Bull: MOM‚Üë √ó BullDiv", group=groupCombo)
useComboBear = input.bool(true,  "Bear: MOM‚Üì √ó BearDiv", group=groupCombo)
comboBars    = input.int(30,     "Ë®±ÂÆπ„Ç¶„Ç£„É≥„Éâ„Ç¶Êú¨Êï∞",    minval=1, group=groupCombo)
orderOpt     = input.string("„Å©„Å°„Çâ„Åß„ÇÇ", "Áô∫ÁîüÈ†ÜÂ∫è", options=["Div‚ÜíMOM„ÅÆ„Åø","MOM‚ÜíDiv„ÅÆ„Åø","„Å©„Å°„Çâ„Åß„ÇÇ"], group=groupCombo)

// ==========================================
// 3. Ë°®Á§∫„Éª„Éá„Ç∂„Ç§„É≥ (Visuals)
// ==========================================
groupView = "Ë°®Á§∫Âà∂Âæ°"
showMOM       = input.bool(true,  "MOMÔºàÂàùÂãïÔºâ„ÇíË°®Á§∫", group=groupView)
showMOMUp     = input.bool(true,  " ‚îî MOM‚Üë", inline="m1", group=groupView)
showMOMDn     = input.bool(true,  "MOM‚Üì",     inline="m1", group=groupView)

showDiv       = input.bool(true,  "Div („ÉÄ„Ç§„Éê„Éº„Ç∏„Çß„É≥„Çπ) „ÇíË°®Á§∫", group=groupView)
divSourceSel  = input.string("RSI+MACD", "DivÂà§ÂÆö„ÇΩ„Éº„Çπ", options=["RSI+MACD","MACD„ÅÆ„Åø","RSI„ÅÆ„Åø"], group=groupView)
divConfirmedOnly = input.bool(false, "Div„ÅØ„ÄéÁ¢∫ÂÆö„ÅÆ„Åø„ÄèË°®Á§∫ÔºàÊú™Á¢∫ÂÆö„ÇíÈö†„ÅôÔºâ", group=groupView)

showConfirm   = input.bool(true,  "ConfirmedÔºàÁ¢∫ÂÆöÔºâ„ÇíË°®Á§∫", group=groupView)
showCombo     = input.bool(true,  "ComboÔºàMOM√óDivÔºâ„ÇíË°®Á§∫", group=groupView)
showLinesPrice= input.bool(true,  "„ÉÄ„Ç§„Éê„Éº„Ç∏„Çß„É≥„Çπ„É©„Ç§„É≥Ôºà‰æ°Ê†ºÔºâ", group=groupView)
showLabels    = input.bool(true,  "„É©„Éô„É´„ÇíË°®Á§∫Ôºà„Éû„Çπ„Çø„ÉºSWÔºâ", group=groupView)

// „Éá„Ç∂„Ç§„É≥Ë®≠ÂÆöÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÂØæÂøúÔºâ
groupStyle = "üé® „Éá„Ç∂„Ç§„É≥„ÉªËâ≤Ë™øÊï¥"
alphaLbl   = input.int(85, "„É©„Éô„É´ËÉåÊôØ„ÅÆÈÄèÊòéÂ∫¶ (0-100)", minval=0, maxval=100, group=groupStyle, tooltip="Êï∞ÂÄ§„ÅåÂ§ß„Åç„ÅÑ„Åª„Å©ËñÑ„Åè„Å™„Çä„Åæ„ÅôÔºàÊé®Â•®: 80-90Ôºâ")
sizeSel    = input.string("normal", "ÊñáÂ≠ó„Çµ„Ç§„Ç∫", options=["tiny","small","normal","large","huge"], group=groupStyle)
textColor  = input.color(color.white, "ÊñáÂ≠óËâ≤", group=groupStyle)
labelGapBars = input.int(5, "„É©„Éô„É´ÈáçË§áÂõûÈÅøÔºàÊúÄÂ∞èÈñìÈöîÔºâ", minval=0, group=groupStyle)

// „É©„Éô„É´‰ΩçÁΩÆ„Ç™„Éï„Çª„ÉÉ„Éà
groupOffset = "„É©„Éô„É´‰ΩçÁΩÆÂæÆË™øÊï¥"
anchorSel = input.string("È´òÂÄ§/ÂÆâÂÄ§", "Âü∫Ê∫ñ‰ΩçÁΩÆ", options=["È´òÂÄ§/ÂÆâÂÄ§","ÁµÇÂÄ§¬±"], group=groupOffset)
offMode   = input.string("Ëá™Âãï", "Ë∑ùÈõ¢Ë®àÁÆó", options=["Ëá™Âãï","ATR","„Éë„Éº„Çª„É≥„Éà"], group=groupOffset)
atrMult   = input.float(0.5, "ATR‰øÇÊï∞", step=0.1, group=groupOffset)
pctPct    = input.float(0.5, "ÔºÖ‰øÇÊï∞", step=0.1, group=groupOffset)

// „É©„Éô„É´„Çµ„Ç§„Ç∫Â§âÊèõ
labelSize = sizeSel=="tiny"?size.tiny:sizeSel=="small"?size.small:sizeSel=="normal"?size.normal:sizeSel=="large"?size.large:size.huge

// ==========================================
// Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ (Calculation Core)
// ==========================================
rsi = ta.rsi(src, rsiLen)
macdLine   = ta.ema(src, fast) - ta.ema(src, slow)
signalLine = ta.ema(macdLine, sig)
hist       = macdLine - signalLine

volSma   = ta.sma(volume, volLen)
volSpike = volume > volSma * volMult

momUp = ta.crossover(hist, 0) and (rsi > rsiUp) and (not useVolFilt or volSpike)
momDn = ta.crossunder(hist, 0) and (rsi < rsiDn) and (not useVolFilt or volSpike)

// „ÉÄ„Ç§„Éê„Éº„Ç∏„Çß„É≥„ÇπÈñ¢Êï∞
f_div(srcSeries, oscSeries, int L_, int R_, int gap_, bool useVol, series bool volSeries, bool isBull) =>
    float pivotVal = isBull ? ta.pivotlow(srcSeries, L_, R_) : ta.pivothigh(srcSeries, L_, R_)
    float oscVal   = isBull ? ta.pivotlow(oscSeries, L_, R_) : ta.pivothigh(oscSeries, L_, R_)
    
    var float prevPivot = na, var float prevOsc = na, var int prevBar = na
    bool detected = false, int trigBar = na
    
    if not na(pivotVal) and not na(oscVal)
        currBar = bar_index - R_
        gapOK = not na(prevBar) ? (currBar - prevBar >= gap_) : false
        volOK = (not useVol) or (bar_index >= R_ and volSeries[R_])
        
        // Bull: ‰æ°Ê†ºÂÆâÂÄ§Êõ¥Êñ∞(Low < prev) „Åã„Å§ OscÂÆâÂÄ§Âàá„Çä‰∏ä„Åí(Osc > prev)
        // Bear: ‰æ°Ê†ºÈ´òÂÄ§Êõ¥Êñ∞(High > prev) „Åã„Å§ OscÈ´òÂÄ§Âàá„Çä‰∏ã„Åí(Osc < prev)
        cond = isBull ? (pivotVal < prevPivot and oscVal > prevOsc) : (pivotVal > prevPivot and oscVal < prevOsc)
        
        if gapOK and cond and volOK
            detected := true
            trigBar  := currBar
            // „É©„Ç§„É≥ÊèèÁîª
            if showLinesPrice
                line.new(prevBar, prevPivot, currBar, pivotVal, xloc=xloc.bar_index, color=isBull ? color.new(color.teal, 50) : color.new(color.maroon, 50), width=2)

        prevPivot := pivotVal
        prevOsc   := oscVal
        prevBar   := currBar
    [detected, trigBar]

// Ê§úÂá∫ÂÆüË°å
[bRSI,  bRSIbar ] = f_div(src, rsi,  L, R, minGap, useVolFilt, volSpike, true)
[sRSI,  sRSIbar ] = f_div(src, rsi,  L, R, minGap, useVolFilt, volSpike, false)
[bMACD, bMACDbar] = f_div(src, hist, L, R, minGap, useVolFilt, volSpike, true)
[sMACD, sMACDbar] = f_div(src, hist, L, R, minGap, useVolFilt, volSpike, false)

bullAny = (bRSI or bMACD)
bearAny = (sRSI or sMACD)
bullDivSel = divSourceSel=="MACD„ÅÆ„Åø" ? bMACD : divSourceSel=="RSI„ÅÆ„Åø" ? bRSI : bullAny
bearDivSel = divSourceSel=="MACD„ÅÆ„Åø" ? sMACD : divSourceSel=="RSI„ÅÆ„Åø" ? sRSI : bearAny

// Á¢∫ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
emaTrend = ta.ema(close, maLen)
emaUp    = ta.rising(emaTrend, trendBars)
emaDn    = ta.falling(emaTrend, trendBars)
trendBullOK = (not useTrendFilt) or (close > emaTrend) or emaUp
trendBearOK = (not useTrendFilt) or (close < emaTrend) or emaDn

bs = ta.barssince(bullDivSel)
ss = ta.barssince(bearDivSel)

hhSinceDiv = (bs >= 0) ? ta.highest(high, bs + 1) : na
llSinceDiv = (ss >= 0) ? ta.lowest(low,  ss + 1)  : na
breakUpOK = (not useSwingBreak) or ((bs > 0) and ta.crossover(close, hhSinceDiv))
breakDnOK = (not useSwingBreak) or ((ss > 0) and ta.crossunder(close, llSinceDiv))

momBullOK = (not useMACDconf) or ta.crossover(macdLine, signalLine) or ta.crossover(hist, 0)
momBearOK = (not useMACDconf) or ta.crossunder(macdLine, signalLine) or ta.crossunder(hist, 0)
rsiBullOK = (not useRSIconf)  or (rsi > 50)
rsiBearOK = (not useRSIconf)  or (rsi < 50)
volConfOK = (not useVolConf)  or volSpike

bullConfirmed = useConfirm and (bs >= 0) and breakUpOK and momBullOK and rsiBullOK and trendBullOK and volConfOK
bearConfirmed = useConfirm and (ss >= 0) and breakDnOK and momBearOK and rsiBearOK and trendBearOK and volConfOK

// „Ç≥„É≥„Éú
bs_bullDiv = ta.barssince(bullDivSel)
bs_bearDiv = ta.barssince(bearDivSel)
bs_momUp   = ta.barssince(momUp)
bs_momDn   = ta.barssince(momDn)

divThenMomUp = (bs_bullDiv >= 0) and (bs_bullDiv <= comboBars) and momUp
momThenDivUp = (bs_momUp   >= 0) and (bs_momUp   <= comboBars) and bullDivSel
divThenMomDn = (bs_bearDiv >= 0) and (bs_bearDiv <= comboBars) and momDn
momThenDivDn = (bs_momDn   >= 0) and (bs_momDn   <= comboBars) and bearDivSel

bullCombo = useComboBull and ((orderOpt != "MOM‚ÜíDiv„ÅÆ„Åø" and divThenMomUp) or (orderOpt != "Div‚ÜíMOM„ÅÆ„Åø" and momThenDivUp))
bearCombo = useComboBear and ((orderOpt != "MOM‚ÜíDiv„ÅÆ„Åø" and divThenMomDn) or (orderOpt != "Div‚ÜíMOM„ÅÆ„Åø" and momThenDivDn))

// ==========================================
// ÊèèÁîª„Éò„É´„Éë„Éº (Drawing)
// ==========================================
atrVal = ta.atr(14)
atrOff = atrVal * atrMult
pctOff = close * (pctPct/100.0)
baseOff = offMode=="Ëá™Âãï" ? math.max(atrOff, pctOff) : offMode=="ATR" ? atrOff : pctOff

getYUp() => anchorSel=="ÁµÇÂÄ§¬±" ? close + baseOff : high + baseOff
getYDn() => anchorSel=="ÁµÇÂÄ§¬±" ? close - baseOff : low  - baseOff

// Ëâ≤Ë®≠ÂÆöÔºàÈÄèÊòéÂ∫¶ÈÅ©Áî®Ôºâ
colMomUp = color.new(color.fuchsia, alphaLbl)
colMomDn = color.new(color.orange,  alphaLbl)
colDivUp = color.new(color.aqua,    alphaLbl)
colDivDn = color.new(color.red,     alphaLbl)
colBull  = color.new(color.teal,    alphaLbl)
colBear  = color.new(color.maroon,  alphaLbl)

// ÊèèÁîªÈñ¢Êï∞
draw(txt, col, isUp) => 
    label.new(bar_index, isUp ? getYUp() : getYDn(), txt, 
              xloc=xloc.bar_index, yloc=yloc.price, 
              style=isUp ? label.style_label_up : label.style_label_down, 
              textcolor=textColor, color=col, size=labelSize)

// Áõ¥Ëøë„Éê„Éº‰øùÊåÅÔºàÈáçË§áÂõûÈÅøÔºâ
var int lastMOMUp = na, var int lastMOMDn = na
var int lastDivUp = na, var int lastDivDn = na
var int lastConfUp= na, var int lastConfDn= na
var int lastComboUp=na, var int lastComboDn=na

allow(lastBar) => na(lastBar) or (bar_index - lastBar >= labelGapBars)

if showLabels
    // MOM
    if showMOM and showMOMUp and momUp and allow(lastMOMUp)
        draw("MOM", colMomUp, true), lastMOMUp := bar_index
    if showMOM and showMOMDn and momDn and allow(lastMOMDn)
        draw("MOM", colMomDn, false), lastMOMDn := bar_index

    // Div
    if showDiv and not divConfirmedOnly and bullDivSel and allow(lastDivUp)
        draw("DIV", colDivUp, true), lastDivUp := bar_index
    if showDiv and not divConfirmedOnly and bearDivSel and allow(lastDivDn)
        draw("DIV", colDivDn, false), lastDivDn := bar_index

    // Confirm
    if showConfirm and bullConfirmed and allow(lastConfUp)
        draw("CONF", colBull, true), lastConfUp := bar_index
    if showConfirm and bearConfirmed and allow(lastConfDn)
        draw("CONF", colBear, false), lastConfDn := bar_index

    // Combo
    if showCombo and bullCombo and allow(lastComboUp)
        draw("CMB", colBull, true), lastComboUp := bar_index
    if showCombo and bearCombo and allow(lastComboDn)
        draw("CMB", colBear, false), lastComboDn := bar_index
